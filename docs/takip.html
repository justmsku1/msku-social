<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kullanıcı Profili - Just MSKU</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
       (function(){
          // BURAYA KENDİ PUBLIC KEY'İNİ YAZ (pylsmgemini.html'deki ile aynı)
          emailjs.init("0HFAh7CQIeDet-qKg");
       })();
    </script>

    <style>
        /* --- GENEL AYARLAR --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; }
        body { background-color: #000; color: #fff; min-height: 100vh; display: flex; flex-direction: column; }

        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 40px; background: #1a1a1a; border-bottom: 1px solid #333; height: 70px; }
        header h1 { color: #24caac; font-size: 24px; cursor: pointer; }
        .back-btn { background: #333; color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 8px; text-decoration: none; font-size: 14px; transition: 0.3s; }
        .back-btn:hover { background: #24caac; color: black; }

        /* PROFİL KARTI */
        .container { max-width: 800px; margin: 0 auto; width: 90%; padding: 30px 0; }
        .profile-card { background: #1a1a1a; border: 1px solid #333; border-radius: 15px; padding: 30px; display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; position: relative; }
        .avatar-circle { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid #24caac; margin-bottom: 15px; background: white; }
        
        .user-name { font-size: 24px; font-weight: bold; margin-bottom: 5px; color: #fff; }
        .user-title { font-size: 14px; color: #24caac; margin-bottom: 5px; font-weight: 600; letter-spacing: 1px; }
        .user-email { font-size: 12px; color: #888; margin-bottom: 15px; font-family: monospace; background: #222; padding: 2px 8px; border-radius: 5px; }
        .bio-text { color: #ccc; text-align: center; max-width: 500px; line-height: 1.6; margin-bottom: 20px; }

        /* BUTONLAR */
        .interaction-btns { display: flex; gap: 15px; margin-bottom: 20px; }
        .btn-action { padding: 10px 25px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-follow { background: #24caac; color: #000; }
        .btn-msg { background: #333; color: #fff; border: 1px solid #555; }
        .btn-msg:hover { border-color: #24caac; }

        /* İSTATİSTİKLER VE SEKMELER */
        .stats-bar { display: flex; gap: 20px; padding-top: 20px; border-top: 1px solid #333; width: 100%; justify-content: center; flex-wrap: wrap; }
        .stat-item { text-align: center; cursor: pointer; padding: 10px 15px; border-radius: 10px; min-width: 80px; transition: 0.2s; }
        .stat-item:hover { background: #222; }
        .stat-item.active { background: rgba(36, 202, 172, 0.1); border-bottom: 2px solid #24caac; }
        .stat-value { font-size: 20px; font-weight: bold; color: #fff; display: block; }
        .stat-label { font-size: 12px; color: #888; }

        /* TAB İÇERİKLERİ */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* GÖNDERİLER */
        .section-title { color: #24caac; margin-bottom: 20px; padding-left: 10px; border-left: 4px solid #24caac; font-size: 16px; }
        .feed-post { background: #1a1a1a; border-radius: 15px; padding: 15px; margin-bottom: 20px; border: 1px solid #333; position: relative;}
        .post-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .user-info-group { display: flex; align-items: center; gap: 10px; }
        .post-header img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .post-content { margin-bottom: 15px; line-height: 1.5; font-size: 15px; }
        .post-image { width: 100%; border-radius: 10px; margin-top: 10px; border: 1px solid #333; max-height: 400px; object-fit: cover; }
        .post-actions { display: flex; gap: 20px; color: #888; border-top: 1px solid #333; padding-top: 10px; margin-top: 10px; }
        .action-btn { cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 13px; }
        .action-btn:hover { color: #24caac; }
        .action-btn.liked { color: #ff4b4b; }

        /* MENÜLER (BİLDİR İÇİN) */
        .post-options { position: relative; }
        .options-btn { background: none; border: none; color: #888; cursor: pointer; font-size: 18px; padding: 5px; }
        .options-menu { display: none; position: absolute; top: 30px; right: 0; background: #222; border: 1px solid #444; border-radius: 8px; width: 120px; z-index: 10; overflow: hidden; flex-direction: column; }
        .options-menu.active { display: flex; }
        .option-item { padding: 10px 15px; color: #ccc; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; text-decoration: none; }
        .option-item:hover { background: #333; color: #fff; }

        .private-msg { text-align: center; color: #888; padding: 40px; background: #111; border-radius: 10px; border: 1px solid #333; margin-top: 20px;}
        .private-msg i { font-size: 40px; margin-bottom: 10px; display: block; }
        
        /* LİSTE ELEMANLARI */
        .user-list-item { display: flex; align-items: center; justify-content: space-between; background: #1a1a1a; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #333; cursor: pointer; }
        .user-list-info { display: flex; align-items: center; gap: 10px; }
        .user-list-info img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .empty-list-msg { text-align: center; padding: 20px; color: #666; font-size: 13px; }
        
        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: #1a1a1a; padding: 20px; border-radius: 15px; width: 90%; max-width: 350px; border: 1px solid #333; text-align: center; max-height: 80vh; overflow-y: auto;}
        .share-contact { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #222; margin-bottom: 5px; border-radius: 8px; cursor: pointer; }
        .share-info { display: flex; align-items: center; gap: 10px; }
        .share-info img { width: 30px; height: 30px; border-radius: 50%; }
        .user-list-btn { background: #333; border: 1px solid #555; color: #fff; padding: 5px 15px; border-radius: 15px; cursor: pointer; font-size: 12px; }
        .modal-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        .modal-btn { padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }

        /* MOBİL UYUMLULUK */
        @media (max-width: 768px) {
            .container { width: 100%; padding: 10px; }
            .profile-card { padding: 20px 10px; }
            .stats-bar { gap: 10px; }
            .stat-item { min-width: 70px; padding: 5px 10px; }
            .stat-value { font-size: 16px; }
            .stat-label { font-size: 11px; }
            header { padding: 10px 15px; }
        }
    </style>
</head>
<body>

    <header>
        <h1 onclick="window.location.href='pylsmgemini.html'">Just MSKU</h1>
        <a href="pylsmgemini.html" class="back-btn"><i class="fa-solid fa-arrow-left"></i> Geri Dön</a>
    </header>

    <div class="container">
        <div class="profile-card">
            <img id="uImg" src="" class="avatar-circle">
            <div id="uName" class="user-name">Yükleniyor...</div>
            <div class="user-title">MSKU</div>
            <div id="uEmail" class="user-email">...</div>
            <div id="uBio" class="bio-text">...</div>

            <div class="interaction-btns">
                <button id="followBtn" class="btn-action btn-follow">Takip Et</button>
                <button id="msgBtn" class="btn-action btn-msg">Mesaj Gönder</button>
            </div>

            <div class="stats-bar">
                <div class="stat-item active" id="tab-posts" onclick="switchTab('posts')">
                    <span id="sPost" class="stat-value">0</span>
                    <span class="stat-label">Gönderi</span>
                </div>
                <div class="stat-item" id="tab-followers" onclick="switchTab('followers')">
                    <span id="sFollowers" class="stat-value">0</span>
                    <span class="stat-label">Takipçi</span>
                </div>
                <div class="stat-item" id="tab-following" onclick="switchTab('following')">
                    <span id="sFollowing" class="stat-value">0</span>
                    <span class="stat-label">Takip</span>
                </div>
            </div>
        </div>

        <div id="content-posts" class="tab-content active">
            <h3 class="section-title">Paylaşımlar</h3>
            <div id="userPosts">
                <div style="text-align:center; color:#555;">Yükleniyor...</div>
            </div>
        </div>

        <div id="content-followers" class="tab-content">
            <h3 class="section-title">Takipçiler</h3>
            <div id="followersList">
                <div class="empty-list-msg">Yükleniyor...</div>
            </div>
        </div>

        <div id="content-following" class="tab-content">
            <h3 class="section-title">Takip Ettikleri</h3>
            <div id="followingList">
                <div class="empty-list-msg">Yükleniyor...</div>
            </div>
        </div>

    </div>

    <div id="shareModal" class="modal">
        <div class="modal-content">
            <h3 style="color:#24caac; margin-bottom:15px;">Gönderiyi Paylaş</h3>
            <div class="share-list" id="shareModalList"></div>
            <button class="user-list-btn" onclick="closeShareModal()" style="margin-top:10px; background:#444; border:none;">Kapat</button>
        </div>
    </div>

    <div id="reportModal" class="modal">
        <div class="modal-content">
            <h3 style="color:#24caac; margin-bottom:15px;">Şikayet Et</h3>
            <textarea id="reportReason" placeholder="Şikayet sebebiniz nedir?" style="width:100%; height:100px; background:#333; color:white; border:1px solid #444; padding:10px; border-radius:5px; outline:none; resize:none; margin-bottom:15px;"></textarea>
            <div class="modal-buttons">
                <button class="modal-btn" style="background:#444; color:white;" onclick="closeReportModal()">İptal</button>
                <button class="modal-btn" style="background:#24caac; color:black;" onclick="submitReport()">Gönder</button>
            </div>
        </div>
    </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, deleteDoc, serverTimestamp, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDLRlyPJvO5tPtnuzNAtO6H0_t7mo_3qoU",
        authDomain: "justmsku.firebaseapp.com",
        projectId: "justmsku",
        storageBucket: "justmsku.firebasestorage.app",
        messagingSenderId: "424626283802",
        appId: "1:424626283802:web:83502f1c09cdcf9acd78a3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let myUid = null;
    let myUsername = null; 
    let targetUid = null;
    let isFollowing = false;
    let relationshipId = null;
    let targetUserData = null;
    let followRequestSent = false;
    let requestId = null;
    const defaultAvatar = "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png";

    const params = new URLSearchParams(window.location.search);
    targetUid = params.get('kisi');

    // Başlangıçta mesaj butonunu gizle
    document.getElementById('msgBtn').style.display = 'none';

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            myUid = user.uid;
            const meDoc = await getDoc(doc(db, "users", myUid));
            if(meDoc.exists()) {
                myUsername = meDoc.data().username;
            }

            if(!targetUid) { alert("Kullanıcı belirtilmedi!"); window.location.href='pylsmgemini.html'; return; }
            if(myUid === targetUid) { window.location.href='profil.html'; return; } 

            loadTargetProfile();
        } else {
            window.location.href = "login.html";
        }
    });

    async function loadTargetProfile() {
        const userDoc = await getDoc(doc(db, "users", targetUid));
        if (!userDoc.exists()) {
            document.querySelector('.container').innerHTML = "<h2 style='text-align:center;margin-top:50px;'>Kullanıcı Bulunamadı.</h2>";
            return;
        }

        targetUserData = userDoc.data();
        document.getElementById('uName').innerText = targetUserData.username;
        document.getElementById('uImg').src = targetUserData.photoURL || defaultAvatar;
        document.getElementById('uBio').innerText = targetUserData.bio || "Biyografi yok.";
        document.getElementById('uEmail').innerText = targetUserData.email || "";

        await checkFollowStatus();
        
        updateFollowBtnUI();
        loadStats();
        checkPrivacyAndLoad();
    }

    async function checkFollowStatus() {
        try {
            // Takip İlişkisi Var mı?
            const qRel = query(
                collection(db, "relationships"), 
                where("followerUid", "==", myUid), 
                where("followingUid", "==", targetUid),
                where("status", "==", "accepted")
            );
            const snapRel = await getDocs(qRel);
            
            if(!snapRel.empty) {
                isFollowing = true;
                relationshipId = snapRel.docs[0].id;
                followRequestSent = false;
                requestId = null;
                return;
            } 
            
            isFollowing = false;
            relationshipId = null;
            
            // Takip İsteği Var mı?
            const qReq = query(collection(db, "friendRequests"), where("fromUid", "==", myUid), where("toUid", "==", targetUid));
            const snapReq = await getDocs(qReq);
            
            if(!snapReq.empty) {
                followRequestSent = true;
                requestId = snapReq.docs[0].id;
            } else {
                followRequestSent = false;
                requestId = null;
            }
        } catch (error) {
            console.error("Takip durumu kontrol edilemedi:", error);
            // Varsayılan değerler
            isFollowing = false;
            relationshipId = null;
            followRequestSent = false;
            requestId = null;
        }
    }

    async function checkPrivacyAndLoad() {
        if (targetUserData.isPrivate && !isFollowing) {
            document.getElementById('userPosts').innerHTML = `
                <div class="private-msg">
                    <i class="fa-solid fa-lock"></i>
                    Bu hesap gizli.<br>Gönderileri görmek için takip et.
                </div>`;
            document.getElementById('followersList').innerHTML = '<div class="empty-list-msg"><i class="fa-solid fa-lock"></i> Bu hesap gizli.</div>';
            document.getElementById('followingList').innerHTML = '<div class="empty-list-msg"><i class="fa-solid fa-lock"></i> Bu hesap gizli.</div>';
        } else {
            loadUserPosts();
        }
    }

    async function loadStats() {
        const qPosts = query(collection(db, "posts"), where("uid", "==", targetUid));
        const sPosts = await getDocs(qPosts);
        document.getElementById('sPost').innerText = sPosts.size;

        const qFollowers = query(collection(db, "relationships"), where("followingUid", "==", targetUid), where("status", "==", "accepted"));
        const sFollowers = await getDocs(qFollowers);
        document.getElementById('sFollowers').innerText = sFollowers.size;

        const qFollowing = query(collection(db, "relationships"), where("followerUid", "==", targetUid), where("status", "==", "accepted"));
        const sFollowing = await getDocs(qFollowing);
        document.getElementById('sFollowing').innerText = sFollowing.size;
    }

    async function loadUserPosts() {
        const feed = document.getElementById('userPosts');
        feed.innerHTML = '<div style="text-align:center; padding:20px;">Yükleniyor...</div>';
        
        try {
            const q = query(
                collection(db, "posts"), 
                where("uid", "==", targetUid), 
                orderBy("timestamp", "desc")
            );
            
            const snapshot = await getDocs(q);

            feed.innerHTML = ''; 

            if(snapshot.empty) {
                feed.innerHTML = '<div style="text-align:center; color:#555; padding:20px;">Henüz gönderi yok.</div>';
                return;
            }

            snapshot.forEach(doc => {
                createPostHTML(doc.id, doc.data(), feed);
            });

        } catch (error) {
            console.error("Gönderi hatası:", error);
            if (error.code === 'failed-precondition') {
                feed.innerHTML = '<div style="color:red; text-align:center;">İndeks Eksik. Console loguna bak.</div>';
            } else {
                feed.innerHTML = '<div style="color:red; text-align:center;">Yüklenirken hata oluştu.</div>';
            }
        }
    }

    function createPostHTML(postId, post, container) {
        let mediaHTML = "";
        if (post.mediaUrl) { 
            if (post.type === 'video') mediaHTML = `<video src="${post.mediaUrl}" controls class="post-image" style="background:#000; width:100%; max-height:400px;"></video>`; 
            else mediaHTML = `<img src="${post.mediaUrl}" class="post-image">`; 
        } else if (post.image) {
            mediaHTML = `<img src="${post.image}" class="post-image">`; 
        }
        
        let dateStr = post.timestamp ? new Date(post.timestamp.seconds * 1000).toLocaleDateString("tr-TR") : "";

        const isLiked = post.likedBy && post.likedBy.includes(myUid);
        const likeClass = isLiked ? 'liked' : '';
        const heartIcon = isLiked ? 'fa-solid' : 'fa-regular';

        const menuHtml = `
            <div class="post-options">
                <button class="options-btn" onclick="toggleMenu('menu-${postId}')"><i class="fa-solid fa-ellipsis"></i></button>
                <div id="menu-${postId}" class="options-menu">
                    <div class="option-item" onclick="openReportModal('${postId}')">Bildir</div>
                </div>
            </div>
        `;

        const html = `
            <div class="feed-post" id="${postId}">
                <div class="post-header">
                    <div class="user-info-group">
                        <img src="${targetUserData.photoURL || defaultAvatar}">
                        <div><strong>${targetUserData.username}</strong><div style="font-size:12px;color:#888;">${dateStr}</div></div>
                    </div>
                    ${menuHtml}
                </div>
                <div class="post-content">${post.text}</div>
                ${mediaHTML}
                
                <div class="post-actions">
                    <div id="like-btn-${postId}" class="action-btn ${likeClass}" onclick="toggleLike('${postId}')">
                        <i class="${heartIcon} fa-heart"></i> <span>${post.likes || 0}</span>
                    </div>
                    <div class="action-btn" onclick="toggleCommentSection('${postId}')">
                        <i class="fa-regular fa-comment"></i> Yorum <span id="count-${postId}"></span>
                    </div>
                    <div class="action-btn" onclick="openShareModal('${postId}')">
                        <i class="fa-solid fa-share-nodes"></i> Paylaş
                    </div>
                </div>

                <div id="comments-${postId}" class="comment-section" style="display:none; margin-top:10px; border-top:1px solid #333; padding-top:10px;">
                    <div class="comment-list" id="list-${postId}" style="margin-bottom:10px;"></div>
                    <div class="comment-input-wrapper" style="display:flex; gap:5px;">
                        <input type="text" id="input-${postId}" placeholder="Yorum yaz..." style="flex:1; background:#222; border:1px solid #444; color:white; padding:5px 10px; border-radius:15px;">
                        <button onclick="saveComment('${postId}')" style="background:#24caac; border:none; padding:5px 10px; border-radius:15px; cursor:pointer;">At</button>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
        loadComments(postId); 
    }

    window.toggleLike = async function(postId) {
        const ref = doc(db, "posts", postId);
        const snap = await getDoc(ref);
        if (snap.exists()) {
            const p = snap.data();
            let likes = p.likes || 0;
            let likedBy = p.likedBy || [];
            
            if(likedBy.includes(myUid)) {
                likes--; likedBy = likedBy.filter(id => id !== myUid);
            } else {
                likes++; likedBy.push(myUid);
            }
            
            await updateDoc(ref, { likes: likes, likedBy: likedBy });
            
            const btn = document.getElementById(`like-btn-${postId}`);
            if(btn) {
                const isLiked = likedBy.includes(myUid);
                btn.className = `action-btn ${isLiked ? 'liked' : ''}`;
                btn.innerHTML = `<i class="${isLiked ? 'fa-solid' : 'fa-regular'} fa-heart"></i> <span>${likes}</span>`;
            }
        }
    }

    window.toggleCommentSection = (id) => {
        const el = document.getElementById(`comments-${id}`);
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    function loadComments(postId) {
        const l = document.getElementById(`list-${postId}`);
        const countSpan = document.getElementById(`count-${postId}`);
        const q = query(collection(db, "comments"), where("postId", "==", postId), orderBy("timestamp", "asc"));
        
        getDocs(q).then(snap => {
            if(countSpan) countSpan.innerText = snap.size > 0 ? snap.size : "";
            l.innerHTML = '';
            snap.forEach(doc => {
                const c = doc.data();
                l.innerHTML += `<div style="font-size:13px; margin-bottom:5px;"><strong style="color:#24caac;">${c.username}</strong>: ${c.text}</div>`;
            });
        });
    }

    window.saveComment = async function(postId) {
        const input = document.getElementById(`input-${postId}`);
        const text = input.value.trim();
        if(!text) return;
        
        const meDoc = await getDoc(doc(db, "users", myUid));
        const meData = meDoc.data();

        await addDoc(collection(db, "comments"), {
            postId: postId,
            text: text,
            uid: myUid,
            username: meData.username,
            userImg: meData.photoURL || defaultAvatar,
            timestamp: serverTimestamp()
        });
        input.value = "";
        loadComments(postId); 
    }

    // --- ŞİKAYET SİSTEMİ ---
    let currentReportPostId = null;
    window.openReportModal = (id) => {
        currentReportPostId = id;
        document.getElementById('reportModal').style.display='flex';
        document.querySelectorAll('.options-menu').forEach(m => m.classList.remove('active'));
    }
    window.closeReportModal = () => {
        document.getElementById('reportModal').style.display='none';
        currentReportPostId = null;
    }

    window.submitReport = async () => {
        const reason = document.getElementById('reportReason').value.trim();
        if(!reason) return alert("Lütfen bir sebep yazınız.");
        
        const btn = document.querySelector('#reportModal .modal-buttons button:last-child');
        btn.innerText = "Gönderiliyor...";
        btn.disabled = true;

        try {
            const postRef = doc(db, "posts", currentReportPostId);
            const postSnap = await getDoc(postRef);
            
            let postOwner = "Bilinmiyor";
            let postContent = "İçerik Yok/Medya";

            if (postSnap.exists()) {
                const p = postSnap.data();
                postOwner = p.username;
                postContent = p.text ? p.text.substring(0, 50) + "..." : "Sadece Görsel/Video";
            }

            const baseUrl = window.location.href.split('takip.html')[0] + 'pylsmgemini.html';
            const postLink = `${baseUrl}?openPost=${currentReportPostId}`;

            await addDoc(collection(db, "reports"), {
                postId: currentReportPostId,
                reason: reason,
                reportedBy: myUid,
                reporterName: myUsername || "Bilinmeyen Kullanıcı",
                timestamp: serverTimestamp()
            });

            const templateParams = {
                reporter_name: myUsername || "Bilinmeyen",
                reason: reason,
                post_id: currentReportPostId,
                post_owner: postOwner,
                post_content: postContent,
                post_link: postLink
            };

            await emailjs.send('service_0z7sl3w', 'template_afv7n7t', templateParams);

            alert("Bildiriminiz yöneticiye iletildi.");
            closeReportModal();

        } catch (error) {
            console.error("Rapor hatası:", error);
            alert("Rapor kaydedildi ancak mail sunucusunda hata oluştu.");
            closeReportModal();
        } finally {
            btn.innerText = "Gönder";
            btn.disabled = false;
        }
    }

    // --- PAYLAŞIM ---
    let currentPostIdToShare = null;
    window.openShareModal = (postId) => {
        currentPostIdToShare = postId;
        document.getElementById('shareModal').style.display = 'flex';
        loadShareList();
    }
    window.closeShareModal = () => document.getElementById('shareModal').style.display = 'none';

    async function loadShareList() {
        const list = document.getElementById('shareModalList');
        list.innerHTML = '<div style="text-align:center; color:#888;">Yükleniyor...</div>';
        
        const q = query(collection(db, "relationships"), where("followerUid", "==", myUid), where("status", "==", "accepted"));
        const snap = await getDocs(q);
        
        list.innerHTML = '';
        if(snap.empty) { list.innerHTML = '<div style="color:#888;">Kimseyi takip etmiyorsun.</div>'; return; }

        snap.forEach(async (d) => {
            const rel = d.data();
            const uDoc = await getDoc(doc(db, "users", rel.followingUid));
            if(uDoc.exists()) {
                const u = uDoc.data();
                const uImg = u.photoURL || defaultAvatar;
                
                const div = document.createElement('div');
                div.className = 'share-contact';
                div.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding:10px; background:#222; margin-bottom:5px; border-radius:8px;';
                div.innerHTML = `
                    <div class="share-info" style="display:flex; align-items:center; gap:10px;">
                        <img src="${uImg}" style="width:35px; height:35px; border-radius:50%; object-fit:cover;">
                        <span>${u.username}</span>
                    </div>
                    <button class="user-list-btn" onclick="shareWithContact('${u.username}', '${u.uid}')" style="background:#24caac; border:none; padding:5px 15px; border-radius:15px; font-weight:bold; cursor:pointer;">
                        Gönder
                    </button>`;
                
                list.appendChild(div);
            }
        });
    }

    window.shareWithContact = async function(contactName, targetUid) {
        if (!currentPostIdToShare) { alert("Hata: Gönderi seçilemedi."); return; }

        try {
            const pDoc = await getDoc(doc(db, "posts", currentPostIdToShare));
            if (!pDoc.exists()) { alert("Hata: Gönderi bulunamadı."); return; }
            const pData = pDoc.data();

            const roomId = [myUid, targetUid].sort().join("_");

            await addDoc(collection(db, "chats", roomId, "messages"), {
                senderId: myUid,
                recipientId: targetUid,
                timestamp: serverTimestamp(),
                isRead: false,
                isSharedPost: true,
                likes: 0,
                likedBy: [],
                postData: {
                    id: currentPostIdToShare,
                    text: pData.text || "",
                    media: pData.mediaUrl || pData.image || null,
                    type: pData.type || 'text',
                    owner: pData.username
                }
            });

            alert(`${contactName} kişisine gönderildi!`);
            closeShareModal();

        } catch (error) {
            console.error("Paylaşım hatası:", error);
            alert("Gönderilirken bir hata oluştu.");
        }
    }

    // --- TAB KONTROLLERİ ---
    window.switchTab = function(tabName) {
        if (targetUserData.isPrivate && !isFollowing && (tabName === 'followers' || tabName === 'following')) {
            return alert("Bu hesap gizli. Listeleri görmek için takip etmelisin.");
        }
        document.querySelectorAll('.stat-item').forEach(i => i.classList.remove('active'));
        document.getElementById('tab-' + tabName).classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('content-' + tabName).classList.add('active');
        
        if (tabName === 'followers' || tabName === 'following') {
             loadLists(tabName);
        }
    }

    async function loadLists(type) {
        const container = document.getElementById(type + 'List');
        container.innerHTML = '<div class="empty-list-msg">Yükleniyor...</div>';
        let q;
        if (type === 'followers') q = query(collection(db, "relationships"), where("followingUid", "==", targetUid), where("status", "==", "accepted"));
        else q = query(collection(db, "relationships"), where("followerUid", "==", targetUid), where("status", "==", "accepted"));
        
        const snapshot = await getDocs(q);
        container.innerHTML = '';
        if (snapshot.empty) { container.innerHTML = '<div class="empty-list-msg">Liste boş.</div>'; return; }

        // İlişki listesi yüklenirken eş zamanlı olarak kullanıcı bilgilerini çekiyoruz
        const userPromises = snapshot.docs.map(docSnap => {
            const rel = docSnap.data();
            const uidToFetch = type === 'followers' ? rel.followerUid : rel.followingUid;
            return getDoc(doc(db, "users", uidToFetch));
        });

        const userDocs = await Promise.all(userPromises);

        userDocs.forEach(uDoc => {
            if(uDoc.exists()) {
                const uData = uDoc.data();
                const uImg = uData.photoURL || defaultAvatar;
                container.insertAdjacentHTML('beforeend', `
                    <div class="user-list-item" onclick="window.location.href='takip.html?kisi=${uData.uid}'">
                        <div class="user-list-info"><img src="${uImg}"><div style="font-weight:600;">${uData.username}</div></div>
                    </div>
                `);
            }
        });
    }

    window.toggleMenu = (id) => document.getElementById(id).classList.toggle('active');
    window.goToChat = function() { window.location.href = `pylsmgemini.html?chatUser=${targetUid}`; }
    window.onclick = (e) => { 
        if(e.target.id === 'shareModal') closeShareModal();
        if(e.target.id === 'reportModal') closeReportModal();
        if(!e.target.closest('.options-btn') && !e.target.closest('.options-menu')) {
            document.querySelectorAll('.options-menu').forEach(m => m.classList.remove('active'));
        }
    }

    async function toggleFollow() {
        try {
            if (isFollowing) {
                // Takibi bırak
                await deleteDoc(doc(db, "relationships", relationshipId));
                isFollowing = false;
                relationshipId = null;
            } else if (followRequestSent) {
                // İsteği iptal et
                await deleteDoc(doc(db, "friendRequests", requestId));
                followRequestSent = false;
                requestId = null;
            } else {
                // Takip isteği gönder veya doğrudan takip et
                if (targetUserData.isPrivate) {
                    const req = await addDoc(collection(db, "friendRequests"), {
                        fromUid: myUid,
                        toUid: targetUid,
                        timestamp: serverTimestamp()
                    });
                    requestId = req.id;
                    followRequestSent = true;
                } else {
                    const rel = await addDoc(collection(db, "relationships"), {
                        followerUid: myUid,
                        followingUid: targetUid,
                        status: "accepted",
                        timestamp: serverTimestamp()
                    });
                    relationshipId = rel.id;
                    isFollowing = true;
                }
            }
            updateFollowBtnUI();
            loadStats();
            checkPrivacyAndLoad(); // Gizlilik kontrolünü yeniden yap
        } catch (error) {
            console.error("Takip işlemi hatası:", error);
            alert("Takip işlemi sırasında hata oluştu.");
        }
    }

    function updateFollowBtnUI() {
        const btn = document.getElementById('followBtn');
        const msgBtn = document.getElementById('msgBtn');
        if (isFollowing) {
            btn.innerText = 'Takip Ediliyor';
            btn.style.background = '#555';
            msgBtn.style.display = 'block';
        } else if (followRequestSent) {
            btn.innerText = 'İstek Gönderildi';
            btn.style.background = '#888';
            btn.style.color = '#000';
            msgBtn.style.display = 'none';
        } else {
            btn.innerText = 'Takip Et';
            btn.style.background = '#24caac';
            msgBtn.style.display = 'none';
        }
    }

    // Event listeners ekle
    document.getElementById('followBtn').addEventListener('click', toggleFollow);
    document.getElementById('msgBtn').addEventListener('click', goToChat);
</script>
</body>
</html>
</body>
</html>