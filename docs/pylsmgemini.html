<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ana Sayfa - Just MSKU</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
       (function(){
          // BURAYA KENDİ PUBLIC KEY'İNİ YAZ
          emailjs.init("0HFAh7CQIeDet-qKg"); 
       })();
    </script>

    <style>
        /* --- TEMA DEĞİŞKENLERİ (SİHİRLİ KISIM) --- */
        :root {
            /* Varsayılan: KARANLIK MOD (Senin Tasarımın) */
            --bg-body: #000000;       /* Ana arka plan */
            --bg-panel: #1a1a1a;      /* Kartlar, Header, Sidebar */
            --bg-hover: #222222;      /* Üzerine gelince, Arama kutusu */
            --bg-input: #333333;      /* Input alanları */
            --border-color: #333333;  /* Çizgiler */
            --text-main: #ffffff;     /* Ana yazılar */
            --text-sub: #aaaaaa;      /* Alt yazılar (gri) */
            --accent: #24caac;        /* Turkuaz Rengi */
            --accent-text: #000000;   /* Buton içindeki yazı rengi */
            --shadow: rgba(0,0,0,0.5);
            --msg-incoming: #333333;  /* Gelen mesaj balonu */
        }

        /* AYDINLIK MOD (Twitter/Facebook Tarzı) */
        body.light-mode {
            --bg-body: #f0f2f5;       /* Açık gri arka plan */
            --bg-panel: #ffffff;      /* Beyaz paneller */
            --bg-hover: #e4e6eb;      /* Hover rengi */
            --bg-input: #f0f2f5;      /* Inputlar */
            --border-color: #e0e0e0;  /* İnce gri çizgiler */
            --text-main: #050505;     /* Siyah yazı */
            --text-sub: #65676b;      /* Koyu gri alt yazı */
            --accent: #24caac;        /* Turkuaz aynı kalır */
            --accent-text: #ffffff;   /* Beyaz modda buton yazısı beyaz olsun */
            --shadow: rgba(0,0,0,0.1);
            --msg-incoming: #e4e6eb;
        }

        /* --- GENEL AYARLAR --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-body); color: var(--text-main); display: flex; flex-direction: column; height: 100vh; overflow: hidden; transition: background-color 0.3s, color 0.3s; }

        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; background: var(--bg-panel); border-bottom: 1px solid var(--border-color); height: 60px; flex-shrink: 0; z-index: 100; position: relative;}
        header h1 { color: var(--accent); font-size: 20px; letter-spacing: 1px; cursor: pointer; white-space: nowrap; }
        .header-right { display: flex; align-items: center; gap: 15px; position: relative; }
        .search-wrapper { position: relative; }
        .header-search { display: flex; align-items: center; background: var(--bg-hover); padding: 8px 15px; border-radius: 20px; width: 250px; transition: 0.3s; border: 1px solid transparent; }
        .header-search:focus-within { background: var(--bg-panel); border: 1px solid var(--accent); }
        .header-search input { background: transparent; border: none; outline: none; color: var(--text-main); margin-left: 10px; width: 100%; font-size: 14px; }
        .header-search i { color: var(--text-sub); }
        .search-results-dropdown { display: none; position: absolute; top: 45px; left: 0; width: 100%; background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 10px; box-shadow: 0 5px 15px var(--shadow); z-index: 1000; overflow: hidden; max-height: 300px; overflow-y: auto; }
        .search-item { padding: 12px 15px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid var(--border-color); color: var(--text-main); }
        .search-item:last-child { border-bottom: none; }
        .search-item:hover { background: var(--accent); color: #000; }
        .search-item img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; background: white; }
        .search-item span { font-size: 13px; font-weight: 600; }

        .request-box { display: flex; align-items: center; background: var(--bg-hover); padding: 8px 15px; border-radius: 20px; cursor: pointer; transition: 0.3s; white-space: nowrap; color: var(--text-main); }
        .request-box:hover { background: var(--accent); color: var(--accent-text); }
        .user-profile-container { position: relative; }
        .user-profile-mini { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 5px 10px; border-radius: 20px; transition: 0.2s; color: var(--text-main); }
        .user-profile-mini:hover { background-color: var(--bg-hover); }
        .user-profile-mini img { width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--accent); background: white; }
        .settings-dropdown { display: none; position: absolute; top: 50px; right: 0; width: 200px; background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 10px; box-shadow: 0 5px 15px var(--shadow); overflow: hidden; flex-direction: column; z-index: 1001;}
        .settings-dropdown.active { display: flex; }
        .dropdown-item { padding: 15px; color: var(--text-main); text-decoration: none; display: flex; align-items: center; gap: 10px; transition: 0.2s; cursor: pointer; font-size: 14px; }
        .dropdown-item:hover { background: var(--bg-hover); }

        /* LAYOUT */
        .main-container { display: flex; flex: 1; overflow: hidden; position: relative; }
        
        /* SIDEBAR (Desktop) */
        .sidebar { width: 250px; background: var(--bg-panel); padding: 20px; display: flex; flex-direction: column; gap: 10px; border-right: 1px solid var(--border-color); flex-shrink: 0; }
        .nav-item { display: flex; align-items: center; gap: 15px; padding: 12px 15px; background: transparent; border-radius: 12px; cursor: pointer; transition: 0.3s; color: var(--text-sub); font-weight: 600; font-size: 14px; position: relative;}
        .nav-item:hover { background: var(--bg-hover); color: var(--text-main); }
        .nav-item.active { background: var(--accent); color: var(--accent-text); }
        .nav-item i { font-size: 18px; width: 25px; text-align: center; }
        /* Badge */
        .nav-badge { position: absolute; top: 5px; right: 10px; background-color: #ff4b4b; color: white; font-size: 10px; font-weight: bold; width: 18px; height: 18px; border-radius: 50%; display: none; justify-content: center; align-items: center; border: 1px solid var(--bg-panel); }

        /* Mobilde pozisyonu biraz değiştir */
        @media (max-width: 1024px) {
            .nav-badge { top: 2px; right: 2px; width: 14px; height: 14px; font-size: 9px; }
        }

        /* Content Area */
        .content-area { flex: 1; background: var(--bg-body); padding: 20px; overflow-y: auto; position: relative; width: 100%; }
        .section { display: none; max-width: 800px; margin: 0 auto; animation: fadeIn 0.3s ease; padding-bottom: 80px; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* POST STYLES */
        .create-post-box { background: var(--bg-panel); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid var(--border-color); }
        .create-post-box textarea { width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-main); padding: 10px; border-radius: 8px; resize: none; min-height: 80px; margin-bottom: 10px; outline: none; }
        .post-tools { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-color); padding-top: 10px; }
        .media-upload-btn { cursor: pointer; color: var(--accent); font-size: 14px; padding: 5px; transition: 0.3s; display: flex; align-items: center; gap: 5px;}
        .post-btn { background: var(--accent); color: var(--accent-text); border: none; padding: 8px 25px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 13px; }
        .image-preview-container { display: none; position: relative; margin-bottom: 10px; }
        .image-preview-container img, .image-preview-container video { width: 100%; max-height: 300px; object-fit: cover; border-radius: 10px; border: 1px solid var(--border-color); }
        .remove-img-btn { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-weight: bold; }

        /* FEED POST */
        .feed-post { background: var(--bg-panel); border-radius: 15px; padding: 15px; margin-bottom: 20px; border: 1px solid var(--border-color); transition: 0.3s; }
        .post-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .user-info-group { display: flex; align-items: center; gap: 10px; color: var(--text-main); cursor: pointer;}
        .user-info-group img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: white; }
        .post-content { margin-bottom: 15px; line-height: 1.5; font-size: 14px; white-space: pre-wrap; color: var(--text-main); }
        .post-image { width: 100%; border-radius: 10px; margin-top: 10px; border: 1px solid var(--border-color); max-height: 500px; object-fit: contain; background: #000; }
        .post-actions { display: flex; justify-content: space-between; color: var(--text-sub); border-top: 1px solid var(--border-color); padding-top: 10px; margin-top: 10px; }
        .action-btn { cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 13px; transition: 0.2s; padding: 5px; }
        .action-btn:hover { color: var(--accent); }
        .action-btn.liked { color: #ff4b4b; }

        /* YORUM ALANI */
        .comment-section { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .comment-list { margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px; }
        .single-comment { display: flex; gap: 10px; font-size: 13px; color: var(--text-main); position: relative; padding: 5px; }
        .single-comment img { width: 25px; height: 25px; border-radius: 50%; background: white; }
        .comment-content { flex: 1; word-break: break-word; }
        .comment-input-wrapper { display: flex; gap: 10px; }
        .comment-input-wrapper input { flex: 1; background: var(--bg-input); border: 1px solid var(--border-color); padding: 8px 15px; border-radius: 20px; color: var(--text-main); outline: none; font-size: 13px; }
        .comment-send-btn { background: var(--accent); border: none; color: var(--accent-text); padding: 0 15px; border-radius: 20px; cursor: pointer; font-weight: bold; }

        /* MENÜLER */
        .post-options { position: relative; }
        .options-btn { background: none; border: none; color: var(--text-sub); cursor: pointer; font-size: 18px; padding: 5px; }
        .options-menu { display: none; position: absolute; top: 30px; right: 0; background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 8px; width: 150px; z-index: 10; overflow: hidden; flex-direction: column; box-shadow: 0 5px 15px var(--shadow); }
        .options-menu.active { display: flex; }
        .option-item { padding: 10px 15px; color: var(--text-main); font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; text-decoration: none; }
        .option-item:hover { background: var(--bg-hover); }
        .option-item.danger { color: #ff4b4b; border-top: 1px solid var(--border-color); }
        .msg-like-count { font-size: 10px; color: #ff4b4b; text-align: right; margin-top: 2px; display: flex; justify-content: flex-end; gap: 3px; align-items: center;}

        /* CHAT ARAYÜZÜ */
        .chat-interface { display: flex; flex-direction: column; height: 75vh; background: var(--bg-panel); border-radius: 15px; overflow: hidden; border: 1px solid var(--border-color); }
        .chat-window { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; position: relative; }
        .msg { padding: 10px 15px; border-radius: 20px; max-width: 70%; font-size: 14px; word-wrap: break-word; position: relative; cursor: pointer; user-select: none; }
        .msg.incoming { background: var(--msg-incoming); color: var(--text-main); align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg.outgoing { background: var(--accent); color: var(--accent-text); align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg:hover .msg-opt-btn { display: block; }
        .msg-opt-btn { position: absolute; top: -5px; right: 5px; background: var(--bg-panel); border-radius: 50%; width: 20px; height: 20px; text-align: center; line-height: 20px; color: var(--text-main); cursor: pointer; display: none; font-size: 10px; border: 1px solid var(--border-color); }
        .msg-menu { position: absolute; top: 15px; right: -10px; background: var(--bg-panel); border: 1px solid var(--border-color); width: 100px; z-index: 100; border-radius: 5px; display: none; flex-direction: column; box-shadow: 0 5px 15px var(--shadow); }
        .msg-menu.active { display: flex; }
        .msg-menu div { padding: 5px 10px; font-size: 11px; cursor: pointer; color: var(--text-main); }
        .msg-menu div:hover { background: var(--bg-hover); }
        .chat-input-area { padding: 15px; background: var(--bg-panel); display: flex; gap: 10px; align-items: center; border-top: 1px solid var(--border-color); }
        .chat-input-area input { flex: 1; padding: 12px; border-radius: 25px; border: none; background: var(--bg-input); color: var(--text-main); outline: none; }
        .chat-input-area button { background: var(--accent); border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-weight: bold; display: flex; justify-content: center; align-items: center; font-size: 16px; color: var(--accent-text); transition: 0.3s;}
        .chat-input-area button:hover { transform: scale(1.05); }
        .shared-post-preview { background: var(--bg-hover); border: 1px solid var(--border-color); border-radius: 10px; padding: 10px; margin-top: 5px; max-width: 100%; cursor: pointer; transition: 0.2s; }
        .sp-media { width: 100%; height: 120px; object-fit: cover; border-radius: 5px; background: #000; }

        /* NOTLAR SİSTEMİ */
        .notes-header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;}
        .notes-search { background: var(--bg-hover); padding: 8px 15px; border-radius: 20px; border: 1px solid var(--border-color); color: var(--text-main); outline: none; flex: 1; min-width: 200px;}
        .breadcrumb { margin-bottom: 20px; color: var(--text-sub); font-size: 14px; }
        .breadcrumb span { color: var(--accent); cursor: pointer; font-weight: bold; }
        .faculty-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .faculty-card { background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 15px; padding: 20px; text-align: center; cursor: pointer; transition: 0.3s; height: 160px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .faculty-card:hover { border-color: var(--accent); transform: translateY(-5px); }
        .faculty-card i { font-size: 30px; color: var(--accent); margin-bottom: 10px; }
        .faculty-card h3 { font-size: 14px; color: var(--text-main); }
        .dept-list, .note-item-list { display: none; flex-direction: column; gap: 10px; }
        .dept-item, .note-list-item { background: var(--bg-panel); padding: 15px; border-radius: 10px; border-left: 4px solid var(--accent); cursor: pointer; transition: 0.2s; color: var(--text-main); }
        .note-list-item:hover { background: var(--bg-hover); }
        .note-list-item { display: flex; flex-direction: column; gap: 10px;} 
        
        /* MODALLER */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; padding: 20px;}
        .modal-content { background: var(--bg-panel); padding: 25px; border-radius: 15px; width: 100%; max-width: 450px; border: 1px solid var(--border-color); text-align: center; max-height: 90vh; overflow-y: auto; color: var(--text-main);}
        .modal input, .modal textarea { width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-main); padding: 10px; border-radius: 5px; margin-bottom: 15px; outline: none; }
        .modal-buttons { display: flex; gap: 10px; justify-content: center; }
        .modal-btn { padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }

        /* SIDEBAR (SAĞ) */
        .right-sidebar { width: 300px; background: var(--bg-panel); padding: 20px; border-left: 1px solid var(--border-color); overflow-y: auto; flex-shrink: 0; display: block;}
        
        /* ARAMA KUTUSU STİLİ */
        .search-wrapper-styled { position: relative; margin-bottom: 15px; background: var(--bg-body); border: 1px solid var(--border-color); border-radius: 20px; padding: 8px 15px; display: flex; align-items: center; gap: 10px; transition: 0.3s; }
        .search-wrapper-styled:focus-within { border-color: var(--accent); background: var(--bg-hover); box-shadow: 0 0 10px rgba(36, 202, 172, 0.1); }
        .search-wrapper-styled i { color: var(--text-sub); font-size: 14px; }
        .search-wrapper-styled input { background: transparent; border: none; outline: none; color: var(--text-main); width: 100%; font-size: 13px; }
        .suggestion-title { color: var(--text-sub); font-size: 13px; margin-bottom: 15px; font-weight: bold; letter-spacing: 1px; }
        .friend-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; cursor: pointer; transition: 0.2s; color: var(--text-main);}
        .friend-row:hover { background: var(--bg-hover); border-radius: 5px; }
        .friend-info { display: flex; align-items: center; gap: 10px; }
        .friend-info img { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; background: white; }
        
        /* TOPLULUK IZGARASI */
        .comm-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .comm-card { background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 15px; overflow: hidden; cursor: pointer; transition: 0.3s; position: relative;}
        .comm-card:hover { border-color: var(--accent); transform: translateY(-5px); }
        .comm-card.selected { border: 2px solid #ff4b4b; opacity: 0.8; }
        .comm-img { width: 100%; height: 120px; object-fit: cover; }
        .comm-content { padding: 15px; text-align: center; }
        
        /* GÜNCELLENEN TOPLULUK DETAY SAYFASI */
        .comm-detail-header { position: relative; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; }
        .comm-cover-img { width: 100%; height: 250px; object-fit: cover; border-radius: 15px 15px 0 0; border: 1px solid var(--border-color); border-bottom: none; mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 70%, rgba(0,0,0,0)); }
        .comm-info-bar { display: flex; justify-content: space-between; align-items: flex-end; padding: 0 20px; margin-top: -60px; position: relative; z-index: 2; flex-wrap: wrap; gap: 15px; }
        .comm-name-badge { background: var(--bg-panel); padding: 20px; border-radius: 15px; border: 1px solid var(--border-color); box-shadow: 0 5px 20px var(--shadow); flex: 1; min-width: 250px; opacity: 0.95; }
        .join-btn { padding: 10px 30px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .join-btn.join { background: var(--accent); color: var(--accent-text); }
        .join-btn.leave { background: #ff4b4b; color: #fff; }
        .comm-admin-settings { position: absolute; top: 15px; right: 15px; z-index: 10; }
        .comm-opt-btn { background: rgba(0,0,0,0.6); color: white; border: 1px solid var(--border-color); width: 35px; height: 35px; border-radius: 50%; cursor: pointer; transition: 0.3s; }
        .comm-opt-btn:hover { background: var(--accent); color: black; border-color: var(--accent); }

        /* KEŞFET GRID */
        .explore-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
        .explore-item { aspect-ratio: 1; background: var(--bg-hover); border-radius: 4px; overflow: hidden; position: relative; }
        .explore-item img, .explore-item video { width: 100%; height: 100%; object-fit: cover; }
        .news-badge { position: absolute; bottom: 5px; left: 5px; background: rgba(36,202,172,0.8); color: #000; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; pointer-events: none; }
        .notification-badge { width: 10px; height: 10px; background: #ff4b4b; border-radius: 50%; display: none; margin-left: auto; }
        
        /* MOBİL İÇİN KİŞİ LİSTESİ ALANI */
        #mobileContactList { display: none; margin-top: 20px; padding: 10px; border-top: 1px solid var(--border-color); }

        /* RESPONSIVE */
        @media (max-width: 1024px) {
            .right-sidebar { display: none !important; }
            .sidebar { width: 70px; align-items: center; } 
            .nav-item span { display: none; } 
            .nav-item { justify-content: center; width: 100%; padding: 15px 0; }
            .nav-item i { margin: 0; font-size: 22px; }
            .header-search { width: 180px; }
        }

        @media (max-width: 768px) {
            header { padding: 0 15px; }
            header h1 { font-size: 18px; }
            
            .header-search { width: 40px; padding: 8px; justify-content: center; background: transparent;}
            .header-search:focus-within { width: 200px; background: var(--bg-panel); position: absolute; left: 10px; z-index: 1010; border: 1px solid var(--border-color);}
            .header-search input { display: block; width: 0; opacity: 0; padding: 0; transition: 0.3s; }
            .header-search:focus-within input { width: 100%; opacity: 1; padding-left: 10px; }
            
            .search-results-dropdown { width: 250px; left: 10px; top: 50px; }
            
            .request-box span { display: none; } 
            .request-box { padding: 8px; }
            .user-profile-mini span, .user-profile-mini i { display: none; } 
            .user-profile-mini { padding: 0; }
            
            .sidebar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; flex-direction: row; justify-content: space-around; border-right: none; border-top: 1px solid var(--border-color); background: var(--bg-panel); padding: 0; z-index: 1000; }
            .nav-item { flex-direction: column; padding: 8px; gap: 4px; border-radius: 0; background: transparent !important; width: auto; }
            .nav-item i { font-size: 20px; width: auto; }
            .nav-item:hover { color: var(--text-sub); } 
            .nav-item.active { color: var(--accent); }
            .sidebar .nav-item span { display: none; }

            .main-container { flex-direction: column; }
            .content-area { padding: 15px; padding-bottom: 80px; } 
            
            .chat-interface { height: calc(100vh - 150px); border-radius: 15px; border: 1px solid var(--border-color); } 
            .chat-window { padding: 15px; }
            .msg { max-width: 80%; }
            #mobileContactList { display: block; } 
            
            .faculty-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .comm-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .explore-grid { grid-template-columns: repeat(3, 1fr); gap: 5px; }
            
            .modal-content { width: 90%; margin: 0 auto; max-height: 80vh; }
            .comm-cover-img { height: 180px; }
            .comm-name-badge { min-width: 100%; text-align: center; margin-top: 0; }
            .comm-info-bar { justify-content: center; margin-top: -40px; padding: 0 10px; }
            .join-btn { width: 100%; margin-top: 10px; }
        }
    </style>
</head>
<body>

    <header>
        <h1 onclick="window.location.href='pylsmgemini.html'">Just MSKU</h1>
        <div class="header-right">
            
            <div class="search-wrapper">
                <div class="header-search" onclick="document.getElementById('globalSearchInput').focus()">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" id="globalSearchInput" placeholder="Ara..." onkeyup="filterUsers()">
                </div>
                <div id="searchResults" class="search-results-dropdown"></div>
            </div>

            <div class="request-box" onclick="window.location.href='profil.html'">
                 <i class="fa-solid fa-heart"></i><span id="navRequestCount">İstekler (0)</span>
            </div>

            <div class="user-profile-container">
                <div class="user-profile-mini" onclick="toggleSettings()"><span id="userNameDisplay">...</span><img id="headerProfileImg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO+ip1sAAAAASUVORK5CYII=" alt="Profil" style="background:white;"><i class="fa-solid fa-chevron-down"></i></div>
                <div id="settingsMenu" class="settings-dropdown">
                    <div class="dropdown-item" onclick="window.location.href='profil.html'">
                        <i class="fa-solid fa-user"></i> Profilim
                    </div>
    
                    <div class="dropdown-item" onclick="toggleTheme()">
                        <i class="fa-solid fa-moon" id="themeIcon"></i> Görünüm Değiştir
                    </div>
                    <div class="dropdown-item" onclick="window.location.href='ayarlar.html'">
                        <i class="fa-solid fa-gear"></i> Ayarlar
                    </div>
                    <div style="border-top: 1px solid var(--border-color); margin: 5px 0;"></div>
                    <div class="dropdown-item" style="color: #ff4b4b;" onclick="userLogout()">
                        <i class="fa-solid fa-right-from-bracket"></i> Çıkış Yap
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <div class="sidebar">
            <div class="nav-item active" onclick="showSection('home')"><i class="fa-solid fa-house"></i><span>Ana Sayfa</span></div>
            <div class="nav-item" onclick="window.location.href='haberler.html'"><i class="fa-solid fa-newspaper"></i><span>Haberler</span></div>
            <div class="nav-item" onclick="showSection('explore')"><i class="fa-solid fa-compass"></i><span>Seyahat</span></div>
            <div class="nav-item" onclick="showSection('chat')"><i class="fa-solid fa-comment"></i><span>Mesajlar</span></div>
            <div class="nav-item" onclick="showSection('notes')"><i class="fa-solid fa-book"></i><span>Notlar</span></div>
            <div class="nav-item" onclick="showSection('communities')"><i class="fa-solid fa-users"></i><span>Topluluklar</span></div>
        </div>

        <div class="content-area">
            
            <div id="home" class="section active">
                <div class="create-post-box">
                    <textarea id="postInput" placeholder="Bir şeyler paylaş..."></textarea>
                    <div id="imagePreviewContainer" class="image-preview-container">
                        <button class="remove-img-btn" onclick="removeImage()">X</button>
                        <img id="imagePreview" src="" alt="Önizleme">
                    </div>
                    <div class="post-tools">
                        <input type="file" id="fileInput" accept="image/*, video/*" style="display: none;" onchange="previewMedia(this)">
                        <label for="fileInput" class="media-upload-btn">
                            <i class="fa-solid fa-image"></i> Medya
                        </label>
                        <button class="post-btn" onclick="sharePost()">Paylaş</button>
                    </div>
                </div>

                <div id="feedContainer">
                    <div id="emptyFeedMsg" style="text-align:center; color:#555; padding:20px;">
                        Henüz akışta gönderi yok.
                    </div>
                </div>
            </div>

            <div id="explore" class="section">
                <h2 style="margin-bottom: 20px; color: #24caac; font-size:18px;">Seyahat</h2>
                <div class="explore-grid"><div class="empty-msg">Yükleniyor...</div></div>
            </div>

            <div id="chat" class="section">
                <div class="chat-interface">
                    
                    <div id="chatContactListScreen" style="padding: 20px; display: flex; flex-direction: column; height: 100%;">
                        <h3 style="color: #24caac; margin-bottom: 15px;">Sohbetler</h3>
                        <div id="chatPageContactList" style="overflow-y: auto; flex: 1;">
                            <div style="color: #666; font-size: 13px; text-align: center;">Kişiler yükleniyor...</div>
                        </div>
                    </div>

                    <div id="activeChatScreen" style="display: none; flex-direction: column; height: 100%;">
                        
                        <div id="chatHeader" style="padding: 10px 15px; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 10px; background: #222;">
                            <button onclick="closeActiveChat()" style="background: none; border: none; color: #ccc; cursor: pointer; font-size: 18px; margin-right: 5px;">
                                <i class="fa-solid fa-arrow-left"></i>
                            </button>
                            <img id="chatHeaderImg" src="" style="width: 35px; height: 35px; border-radius: 50%; background: white;">
                            <div>
                                <div id="chatHeaderName" style="font-weight: bold; font-size:14px; color: white;">...</div>
                                <div style="font-size: 10px; color: #24caac;">Çevrimiçi</div>
                            </div>
                        </div>

                        <div class="chat-window" id="chatBox" style="flex: 1; padding: 15px; overflow-y: auto;">
                            </div>
                        
                        <div id="replyPreviewBar" class="reply-preview-bar" style="display:none; background:#222; border-top:1px solid #24caac; padding:5px 10px; font-size:12px; color:#aaa; justify-content:space-between; align-items:center;">
                            <span id="replyToText">Yanıtlanıyor...</span>
                            <span style="cursor:pointer; font-weight:bold;" onclick="cancelReply()">X</span>
                        </div>

                        <div class="chat-input-area">
                            <input type="text" id="chatMsgInput" placeholder="Bir mesaj yaz...">
                            <button onclick="sendChatMessage()"><i class="fa-solid fa-paper-plane"></i></button>
                        </div>
                    </div>

                </div>
            </div>

            <div id="notes" class="section">
                <div class="notes-header-bar">
                    <h2 style="color: #24caac; font-size:18px;">Ders Notları</h2>
                    <input type="text" id="notesSearchInput" class="notes-search" placeholder="Ara..." onkeyup="filterNotesItems()">
                    <button id="addNoteBtn" class="add-note-btn" onclick="openModal()" style="display:none; background: #24caac; border:none; padding:5px 15px; border-radius:15px; font-weight:bold;">Ekle</button>
                </div>
                <div class="breadcrumb" id="breadcrumb">
                    <span onclick="renderFaculties()">Fakülteler</span>
                </div>
                <div id="facultyGrid" class="faculty-grid"></div>
                <div id="deptList" class="dept-list"></div>
                <div id="deptNotesList" class="note-item-list"></div>
            </div>

            <div id="communities" class="section">
                <div class="comm-header-bar" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2 style="color:#24caac; font-size:18px;">Topluluklar</h2>
                    
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button id="superAdminBtn" class="btn btn-danger" onclick="toggleDeleteMode()" style="display: none; padding:8px 15px; font-size:12px; border-radius: 20px;">
                            <i class="fa-solid fa-trash-can"></i> Gereksizleri Sil
                        </button>
                        
                        <div id="deleteActions" style="display: none; gap: 10px; align-items: center;">
                            <span id="deleteCount" style="color:#ff4b4b; font-size:12px; font-weight:bold;">0 seçildi</span>
                            <button class="btn btn-danger" onclick="deleteSelectedCommunities()" style="padding:5px 10px; font-size:11px;">Onayla</button>
                            <button class="btn" onclick="toggleDeleteMode()" style="padding:5px 10px; font-size:11px; background:#444; color:#fff;">İptal</button>
                        </div>

                        <button class="add-news-btn" onclick="openCommModal()" style="background:#24caac; border:none; padding:8px 15px; border-radius:20px; font-weight:bold; font-size:12px;">Yeni</button>
                    </div>
                </div>
                <div id="communityGrid" class="comm-grid">
                    <div style="color:#888;text-align:center;">Yükleniyor...</div>
                </div>
            </div>

            <div id="communityDetail" class="section">
                <button class="back-link back-btn" onclick="closeCommunityDetail()" style="margin-bottom:15px; background:none; border:none; color:#ccc; display:flex; align-items:center; gap:5px; cursor:pointer;">
                    <i class="fa-solid fa-arrow-left"></i> Geri Dön
                </button>

                <div class="comm-detail-header">
                    <img id="cdCover" src="" class="comm-cover-img">
                    
                    <div class="comm-admin-settings" id="commAdminOptions" style="display:none;">
                        <button class="comm-opt-btn" onclick="toggleCommAdminMenu()"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                        <div id="commAdminMenu" class="options-menu" style="right:0; top:40px;">
                            <div class="option-item" onclick="triggerCommunityImageUpdate()">Görseli Değiştir</div>
                            <div class="option-item" onclick="changeCommunityAdmin()">Yöneticiyi Değiştir</div>
                            <div class="option-item danger" onclick="deleteCurrentCommunity()">Topluluğu Sil</div>
                        </div>
                    </div>
                    
                    <input type="file" id="updateCommImgInput" accept="image/*" style="display:none;" onchange="updateCommunityImage(this)">

                    <div class="comm-info-bar">
                        <div class="comm-name-badge">
                            <h2 id="cdName" style="font-size:22px; margin:0; color:#24caac; font-weight:800;">Topluluk Adı</h2>
                            <span id="cdDesc" style="font-size:13px; display:block; margin-top:5px; color:#ddd; line-height:1.4;">Açıklama yükleniyor...</span>
                            <span id="cdAdminBadge" class="admin-badge" style="display:none; background:#ffd700; color:#000; padding:3px 8px; font-size:10px; border-radius:5px; margin-top:5px; font-weight:bold; display:inline-block;">YÖNETİCİ</span>
                        </div>
                        <button id="cdJoinBtn" class="join-btn join" onclick="toggleJoin()">Katıl</button>
                    </div>
                </div>

                <div id="commAdminPostBox" class="create-post-box" style="display:none;">
                    <div style="font-size:12px; color:#24caac; margin-bottom:8px; font-weight:bold;"><i class="fa-solid fa-bullhorn"></i> Yönetici Duyurusu Yap:</div>
                    <textarea id="commPostInput" placeholder="Topluluk üyelerine duyuru yap..."></textarea>
                    <div id="commImagePreviewContainer" class="image-preview-container">
                        <button class="remove-img-btn" onclick="removeCommImage()">X</button>
                        <img id="commImagePreview" src="" alt="Önizleme">
                    </div>
                    <div class="post-tools">
                        <input type="file" id="commFileInput" accept="image/*, video/*" style="display: none;" onchange="previewCommMedia(this)">
                        <label for="commFileInput" class="media-upload-btn" style="color:#24caac;">
                            <i class="fa-solid fa-image"></i> Medya
                        </label>
                        <button class="post-btn" onclick="shareCommunityPost()">Paylaş</button>
                    </div>
                </div>

                <div id="commFeedContainer">
                    <div class="empty-msg">Yükleniyor...</div>
                </div>
            </div>

        </div>

        <div class="right-sidebar">
            <div id="followersBox" class="suggestion-box">
                <div class="suggestion-title">TAKİPÇİLER <span id="sidebarFollowerCount" style="color:#888;">(0)</span></div>
                
                <div class="search-wrapper-styled">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" id="followerSearchInput" placeholder="Takipçi ara..." onkeyup="filterFollowers()">
                </div>

                <div id="followersList">
                    <div style="color: #888; font-size: 13px; text-align: center; padding: 10px;">Yükleniyor...</div>
                </div>
            </div>

            <div id="contactsBox" class="suggestion-box" style="display: none;">
                <div class="suggestion-title" style="color:#24caac;">KİŞİLERİM</div>
                
                <div class="search-wrapper-styled">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" id="contactSearchInput" placeholder="Kişi ara..." onkeyup="filterContacts()">
                </div>

                <div id="contactsList">
                    <div style="color: #888; font-size: 13px; text-align: center; padding: 10px;">Sohbet edecek kimse yok.</div>
                </div>
            </div>

            <div id="commSearchBox" class="suggestion-box" style="display: none;">
                <div class="suggestion-title" style="color:#24caac;">TOPLULUK ARA</div>
                <div class="search-wrapper-styled">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" id="commSearchInput" placeholder="Topluluk adı..." onkeyup="filterCommunities()">
                </div>
            </div>
        </div>
    </div>

    <div id="noteDetailModal" class="modal">
        <div class="modal-content" style="text-align:left;">
            <span class="close-btn" onclick="closeNoteDetailModal()" style="float:right; cursor:pointer; font-size:24px;">&times;</span>
            <h2 id="ndTitle" style="color:#24caac; margin-bottom:10px;"></h2>
            <div style="font-size:12px; color:#888; margin-bottom:15px;">
                <span id="ndAuthor"></span> • <span id="ndDate"></span>
            </div>
            <p id="ndDesc" style="color:#ddd; margin-bottom:15px; white-space: pre-wrap; font-size:14px;"></p>
            <div id="ndFileContainer" style="margin-bottom:20px; text-align:center;"></div>
            <div class="modal-buttons">
                <a id="ndDownloadBtn" href="#" target="_blank" class="modal-btn" style="background:#24caac; color:black; text-decoration:none; display:inline-flex; align-items:center; gap:5px;"><i class="fa-solid fa-download"></i> İndir</a>
                <button id="ndDeleteBtn" class="modal-btn" style="background:#ff4b4b; color:white; display:none;" onclick=""><i class="fa-solid fa-trash"></i> Sil</button>
            </div>
        </div>
    </div>

    <div id="noteModal" class="modal">
        <div class="modal-content">
            <h2 style="color:#24caac; margin-bottom:15px; font-size:18px;">Not Paylaş</h2>
            <input type="text" id="noteTitle" placeholder="Konu">
            <input type="text" id="noteAuthor" placeholder="Ad Soyad">
            <textarea id="noteDesc" placeholder="Açıklama"></textarea>
            <input type="file" id="noteFile">
            <div class="modal-buttons">
                <button class="modal-btn" style="background:#444; color:white;" onclick="closeModal()">İptal</button>
                <button class="modal-btn" style="background:#24caac; color:black;" onclick="saveNote()">Paylaş</button>
            </div>
        </div>
    </div>
    
    <div id="newsDetailModal" class="modal">
        <div class="modal-content" style="text-align:left; max-width:600px;">
            <span style="float:right; cursor:pointer; font-size:20px;" onclick="closeNewsDetailModal()">&times;</span>
            <div id="detailNewsMediaContainer"></div>
            <h2 id="detailNewsTitle" style="color:#24caac; margin-bottom:10px;"></h2>
            <div style="font-size:12px; color:#888; margin-bottom:15px;">
                <span id="detailNewsAuthor"></span> • <span id="detailNewsDate"></span>
            </div>
            <p id="detailNewsContent" style="line-height:1.6; color:#ddd; white-space: pre-wrap; font-size:14px;"></p>
        </div>
    </div>

    <div id="shareModal" class="modal">
        <div class="modal-content" style="width: 300px;">
            <h3 style="color:#24caac; margin-bottom:15px;">Paylaş</h3>
            <div class="share-list" id="shareModalList"></div>
            <button class="modal-btn" style="background:#444; color:white; margin-top:10px;" onclick="closeShareModal()">Kapat</button>
        </div>
    </div>

    <div id="commModal" class="modal">
        <div class="modal-content">
            <h2 style="color:#24caac; font-size:18px;">Topluluk Kur</h2>
            <input type="text" id="cName" placeholder="Topluluk Adı">
            <textarea id="cDesc" placeholder="Kısa açıklama..."></textarea>
            <input type="file" id="cFile" accept="image/*">
            <div class="modal-buttons">
                <button class="modal-btn" style="background:#444;color:white;" onclick="closeCommModal()">İptal</button>
                <button class="modal-btn" style="background:#24caac;color:black;" onclick="createCommunity()">Oluştur</button>
            </div>
        </div>
    </div>
    
    <div id="newsModal" class="modal">
        <div class="modal-content">
            <h2 style="color:#24caac; margin-bottom:15px;">Haber Ekle</h2>
            <input type="text" id="newsTitle" placeholder="Başlık">
            <textarea id="newsContent" placeholder="İçerik"></textarea>
            <input type="file" id="newsFile" accept="image/*, video/*">
            <div class="modal-buttons">
                <button class="modal-btn" style="background:#444; color:white;" onclick="closeNewsModal()">İptal</button>
                <button class="modal-btn" style="background:#24caac; color:black;" onclick="shareNews()">Paylaş</button>
            </div>
        </div>
    </div>

    <div id="reportModal" class="modal">
        <div class="modal-content">
            <h3 style="color:#24caac; margin-bottom:15px;">Şikayet Et</h3>
            <textarea id="reportReason" placeholder="Şikayet sebebiniz nedir?" style="width:100%; height:100px; background:#333; color:white; border:1px solid #444; padding:10px; border-radius:5px; outline:none; resize:none; margin-bottom:15px;"></textarea>
            <div class="modal-buttons">
                <button class="modal-btn" style="background:#444; color:white;" onclick="closeReportModal()">İptal</button>
                <button class="modal-btn" style="background:#24caac; color:black;" onclick="submitReport()">Gönder</button>
            </div>
        </div>
    </div>

    <script>
        function goToProfile(username) {
            window.location.href = 'takip.html?kisi=' + username;
        }
    </script>

    <script type="module">
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, limit, doc, getDoc, setDoc, onSnapshot, addDoc, orderBy, deleteDoc, updateDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        
        // FIREBASE AYARLARI
        const firebaseConfig = {
            apiKey: "AIzaSyDLRlyPJvO5tPtnuzNAtO6H0_t7mo_3qoU",
            authDomain: "justmsku.firebaseapp.com",
            projectId: "justmsku",
            storageBucket: "justmsku.firebasestorage.app",
            messagingSenderId: "424626283802",
            appId: "1:424626283802:web:83502f1c09cdcf9acd78a3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // --- BURAYA YAPIŞTIR ---
    
        
        // DEĞİŞKENLER
        let myUser = null;
        let currentUserUid = null;
        let currentChatPartnerUid = null;
        let activeChatUnsubscribe = null;
        let replyingTo = null;
        let editingMsgId = null; 
        let currentMediaData = null;
        let currentMediaType = null;
        
        let explorePostData = [];
        let exploreNewsData = [];
        let allCommunitiesCache = []; 
        window.newsDataCache = {}; 
        window.notesDataCache = {}; 
        let currentSelectedDepartment = null; 
        
        let currentOpenedCommunityId = null;
        let currentOpenedCommunityAdminId = null;
        let currentCommMediaType = 'image';

        const defaultUserImg = "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png";;

        // OTURUM KONTROLÜ
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserUid = user.uid;
                const userDocRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    myUser = docSnap.data();
                    myUser.uid = user.uid;

                    // --- EKSİK VERİ TAMİRİ ---
                    if (!myUser.searchKey) {
                        const searchKeyGen = myUser.username ? myUser.username.toLowerCase() : user.email.split('@')[0].toLowerCase();
                        await updateDoc(userDocRef, {
                            searchKey: searchKeyGen
                        });
                        console.log("Kullanıcı searchKey onarıldı.");
                    }
                } else {
                    // --- DÖKÜMANI OLMAYAN KULLANICIYI OLUŞTUR ---
                    const usernameGen = user.email.split('@')[0];
                    const newUserData = {
                        uid: user.uid,
                        username: usernameGen,
                        email: user.email,
                        photoURL: defaultUserImg,
                        searchKey: usernameGen.toLowerCase(),
                        createdAt: serverTimestamp()
                    };
                    
                    await setDoc(userDocRef, newUserData);
                    myUser = newUserData;
                    console.log("Eksik kullanıcı dökümanı oluşturuldu.");
                }

                // --- KULLANICIYI ÇEVRİMİÇİ OLARAK İŞARETLE ---
                await updateDoc(userDocRef, { isOnline: true });

                document.getElementById('userNameDisplay').textContent = myUser.username;
                
                const headerImg = document.getElementById('headerProfileImg');
                if (headerImg) {
                    headerImg.src = myUser.photoURL || defaultUserImg;
                }
                
                if(user.email === "abdulkadiroluc@posta.mu.edu.tr") {
                    document.getElementById('superAdminBtn').style.display = "flex";
                }

                subscribeToRequests(user.uid);
                loadSidebarLists(user.uid);
                loadTimeline(); 
                loadExploreMixed(); 
                loadCommunities();

                // --- URL'DEN SOHBET YAKALAMA ---
                const params = new URLSearchParams(window.location.search);
                const chatTargetUid = params.get('chatUser');

                if (chatTargetUid) {
                    showSection('chat');
                    const uDoc = await getDoc(doc(db, "users", chatTargetUid));
                    if (uDoc.exists()) {
                        const uData = uDoc.data();
                        loadChat(uData.username, uData.photoURL || defaultUserImg, chatTargetUid);
                    }
                    window.history.replaceState({}, document.title, "pylsmgemini.html");
                }
                // -----------------------------------------------------

            } else {
                window.location.href = "login.html";
            }
        });

        const mskuData = { 
            "Mühendislik Fakültesi": { icon: "fa-solid fa-laptop-code", bolumler: ["Elektrik-Elektronik Mühendisliği","Bilgisayar Mühendisliği", "İnşaat Mühendisliği", "Yazılım Mühendisliği", "Maden Mühendisliği"] }, 
            "Tıp Fakültesi": { icon: "fa-solid fa-user-doctor", bolumler: ["Tıp", "Cerrahi Tıp Bilimleri", "Dahili Tıp Bilimleri", "Temel Tıp Bilimleri"] },
            "Sağlık Bilimleri Fakültesi": { icon: "fa-solid fa-heart-pulse", bolumler: ["Hemşirelik", "Fizyoterapi ve Rehabilitasyon", "Beslenme ve Diyetetik", "Ebelik", "Sağlık Yönetimi"] },
            "İslami İlimler Fakültesi": { icon: "fa-solid fa-mosque", bolumler: ["Temel İslam Bilimleri", "Felsefe ve Din Bilimleri", "İslam Tarihi ve Sanatları"] },
            "İktisadi ve İdari Bilimler Fakültesi": { icon: "fa-solid fa-briefcase", bolumler: ["İktisat", "İşletme", "Siyaset Bilimi ve Kamu Yönetimi", "Uluslararası İlişkiler", "Çalışma Ekonomisi"] },
            "Eğitim Fakültesi": { icon: "fa-solid fa-chalkboard-user", bolumler: ["Temel Eğitim", "Türkçe ve Sosyal Bilimler Eğitimi", "Matematik ve Fen Bilimleri Eğitimi", "Yabancı Diller Eğitimi", "Rehberlik ve Psikolojik Danışmanlık"] },
            "Teknoloji Fakültesi": { icon: "fa-solid fa-microchip", bolumler: ["Bilişim Sistemleri Mühendisliği", "Enerji Sistemleri Mühendisliği", "Ağaç İşleri Endüstri Mühendisliği"] },
            "Spor Bilimleri Fakültesi": { icon: "fa-solid fa-person-running", bolumler: ["Beden Eğitimi ve Spor Öğretmenliği", "Antrenörlük Eğitimi", "Spor Yöneticiliği", "Rekreasyon"] },
            "Turizm Fakültesi": { icon: "fa-solid fa-plane-departure", bolumler: ["Turizm İşletmeciliği", "Gastronomi ve Mutfak Sanatları", "Turizm Rehberliği", "Yiyecek İçecek İşletmeciliği"] },
            "Mimarlık Fakültesi": { icon: "fa-solid fa-city", bolumler: ["Mimarlık", "Şehir ve Bölge Planlama"] },
            "Güzel Sanatlar Fakültesi": { icon: "fa-solid fa-palette", bolumler: ["Resim", "Grafik", "Heykel", "Seramik", "Sahne Sanatları"] }
        };

        // NOTLAR FONKSİYONLARI
        window.renderFaculties = () => { 
            document.getElementById('facultyGrid').style.display = 'grid';
            document.getElementById('deptList').style.display = 'none';
            document.getElementById('deptNotesList').style.display = 'none';
            document.getElementById('addNoteBtn').style.display = 'none'; 
            document.getElementById('breadcrumb').innerHTML = '<span onclick="renderFaculties()">Fakülteler</span>';
            const g = document.getElementById('facultyGrid'); g.innerHTML=''; 
            for(const [k,v] of Object.entries(mskuData)) 
                g.innerHTML+=`<div class="faculty-card" onclick="showDepartments('${k}')"><i class="${v.icon}"></i><h3>${k}</h3></div>`; 
        }

        window.showDepartments = (fakulteAdi) => {
            const fakulte = mskuData[fakulteAdi];
            if(!fakulte) return;
            document.getElementById('facultyGrid').style.display = 'none';
            const deptList = document.getElementById('deptList');
            deptList.innerHTML = ''; deptList.style.display = 'flex';
            document.getElementById('addNoteBtn').style.display = 'none'; 
            document.getElementById('breadcrumb').innerHTML = `<span onclick="renderFaculties()">Fakülteler</span> > <span>${fakulteAdi}</span>`;
            fakulte.bolumler.forEach(bolum => {
                deptList.innerHTML += `<div class="dept-item" onclick="showNotes('${bolum}')" style="padding:15px; background:#1a1a1a; margin-bottom:10px; border-radius:10px; cursor:pointer; border-left:4px solid #24caac;">${bolum}</div>`;
            });
        }

        window.showNotes = (bolumAdi) => {
            currentSelectedDepartment = bolumAdi;
            document.getElementById('deptList').style.display = 'none';
            document.getElementById('addNoteBtn').style.display = 'block'; 
            const noteList = document.getElementById('deptNotesList');
            noteList.innerHTML = '<div class="empty-msg">Notlar yükleniyor...</div>';
            noteList.style.display = 'flex';
            const currentHTML = document.getElementById('breadcrumb').innerHTML;
            if(!currentHTML.includes(bolumAdi)) { document.getElementById('breadcrumb').innerHTML = `${currentHTML} > <span>${bolumAdi}</span>`; }
            
            try {
                const q = query(collection(db, "notes"), where("department", "==", bolumAdi), orderBy("timestamp", "desc"));
                onSnapshot(q, (snapshot) => {
                    noteList.innerHTML = '';
                    if (snapshot.empty) { noteList.innerHTML = '<div class="empty-msg">Bu bölümde henüz not paylaşılmamış.</div>'; return; }
                    snapshot.forEach(doc => {
                        const note = doc.data();
                        note.id = doc.id;
                        window.notesDataCache[note.id] = note; 
                        const date = new Date(note.timestamp.seconds * 1000).toLocaleDateString("tr-TR");
                        noteList.innerHTML += `
                            <div class="note-list-item" onclick="viewNoteDetail('${note.id}')" style="cursor:pointer;">
                                <div>
                                    <div style="font-weight:bold; font-size:15px; margin-bottom:5px;">${note.title}</div>
                                    <div style="font-size:12px; color:#aaa; margin-bottom:5px;">${note.description ? note.description.substring(0,50)+'...' : ''}</div>
                                    <div style="font-size:11px; color:#666;"><i class="fa-solid fa-user"></i> ${note.uploadedBy} &nbsp;&nbsp; <i class="fa-regular fa-calendar"></i> ${date}</div>
                                </div>
                                <div style="background: #333; color: #24caac; padding: 5px 15px; border-radius: 15px; font-size: 12px; border: 1px solid #24caac;">
                                    <i class="fa-solid fa-eye"></i> İncele
                                </div>
                            </div>`;
                    });
                }, (error) => {
                    console.error("Not yükleme hatası:", error);
                    if (error.code === 'failed-precondition') {
                        noteList.innerHTML = '<div class="empty-msg" style="color:red;">Sistem Hatası: İndeks oluşturulmalı.</div>';
                    } else {
                        noteList.innerHTML = '<div class="empty-msg" style="color:red;">Yüklenirken hata oluştu.</div>';
                    }
                });
            } catch(e) { console.error(e); }
        }

        window.saveNote = async function() {
            const title = document.getElementById('noteTitle').value; 
            const desc = document.getElementById('noteDesc').value; 
            const fileInput = document.getElementById('noteFile');
            const file = fileInput.files[0];
            const btn = document.querySelector('#noteModal .modal-buttons button:last-child'); 
            
            if(!title || !file) return alert("Başlık ve dosya zorunludur.");
            
            if (file.size > 700 * 1024) {
                alert("Dosya boyutu çok yüksek! Lütfen 700KB altında bir dosya yükleyin.");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Yükleniyor...";

            const reader = new FileReader(); 
            reader.readAsDataURL(file); 
            reader.onload = async function () {
                const base64File = reader.result;
                try {
                    await addDoc(collection(db, "notes"), { 
                        department: currentSelectedDepartment, 
                        title: title, 
                        description: desc, 
                        file: base64File, 
                        uploadedBy: myUser.username, 
                        uid: myUser.uid, 
                        timestamp: new Date() 
                    });
                    
                    closeModal(); 
                    document.getElementById('noteTitle').value = ""; 
                    document.getElementById('noteDesc').value = ""; 
                    document.getElementById('noteFile').value = ""; 
                    alert("Not başarıyla yüklendi!");
                } catch (error) {
                    console.error("Yükleme hatası:", error);
                    alert("Yükleme başarısız oldu.");
                } finally {
                    btn.disabled = false;
                    btn.innerText = "Paylaş";
                }
            };
        }
        
        window.viewNoteDetail = (noteId) => {
            const note = window.notesDataCache[noteId];
            if(!note) return;

            document.getElementById('ndTitle').innerText = note.title;
            document.getElementById('ndAuthor').innerText = note.uploadedBy;
            document.getElementById('ndDate').innerText = new Date(note.timestamp.seconds * 1000).toLocaleDateString("tr-TR");
            document.getElementById('ndDesc').innerText = note.description;
            
            const container = document.getElementById('ndFileContainer');
            container.innerHTML = '';
            
            if(note.file.startsWith('data:image')) {
                container.innerHTML = `<img src="${note.file}" style="max-width:100%; max-height:300px; border-radius:10px; border:1px solid #333;">`;
            } else {
                container.innerHTML = `<div style="padding:20px; background:#222; border-radius:10px;"><i class="fa-solid fa-file-pdf" style="font-size:40px; color:#ccc;"></i><br><span style="font-size:12px; color:#888;">Dosya Önizlemesi (PDF)</span></div>`;
            }

            document.getElementById('ndDownloadBtn').href = note.file;
            
            const deleteBtn = document.getElementById('ndDeleteBtn');
            if(note.uid === currentUserUid) {
                deleteBtn.style.display = 'inline-block';
                deleteBtn.onclick = () => deleteNote(noteId);
            } else {
                deleteBtn.style.display = 'none';
            }

            document.getElementById('noteDetailModal').style.display = 'flex';
        }

        window.closeNoteDetailModal = () => document.getElementById('noteDetailModal').style.display = 'none';

        window.deleteNote = async (noteId) => {
            if(!confirm("Bu notu silmek istediğinize emin misiniz?")) return;
            try {
                await deleteDoc(doc(db, "notes", noteId));
                closeNoteDetailModal();
                alert("Not silindi.");
            } catch(e) {
                console.error(e);
                alert("Silinirken hata oluştu.");
            }
        }

        window.filterNotesItems = function() {
            const val = document.getElementById('notesSearchInput').value.toLowerCase();
            if(document.getElementById('facultyGrid').style.display !== 'none') {
                const cards = document.querySelectorAll('.faculty-card'); 
                cards.forEach(c => { const txt = c.innerText.toLowerCase(); c.style.display = txt.includes(val) ? 'flex' : 'none'; });
            } else if(document.getElementById('deptList').style.display !== 'none') {
                const depts = document.querySelectorAll('.dept-item'); 
                depts.forEach(d => { const txt = d.innerText.toLowerCase(); d.style.display = txt.includes(val) ? 'block' : 'none'; });
            } else if(document.getElementById('deptNotesList').style.display !== 'none') {
                const notes = document.querySelectorAll('.note-list-item'); 
                notes.forEach(n => { const txt = n.innerText.toLowerCase(); n.style.display = txt.includes(val) ? 'flex' : 'none'; });
            }
        }

        window.filterContacts = function() {
            const val = document.getElementById('contactSearchInput').value.toLowerCase();
            const contacts = document.querySelectorAll('#contactsList .friend-row');
            contacts.forEach(row => {
                const name = row.querySelector('.friend-info div:nth-child(2) div:nth-child(1)').innerText.toLowerCase();
                row.style.display = name.includes(val) ? 'flex' : 'none';
            });
        }
        
        window.filterFollowers = function() {
            const val = document.getElementById('followerSearchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#followersList .friend-row');
            rows.forEach(row => {
                const name = row.querySelector('.friend-info span').innerText.toLowerCase();
                row.style.display = name.includes(val) ? 'flex' : 'none';
            });
        }
        
        window.filterCommunities = function() {
            const val = document.getElementById('commSearchInput').value.toLowerCase();
            const filtered = allCommunitiesCache.filter(c => c.name.toLowerCase().includes(val) || (c.description && c.description.toLowerCase().includes(val)));
            renderCommunityGrid(filtered);
        }

        function renderCommunityGrid(dataList) {
            const grid = document.getElementById('communityGrid'); grid.innerHTML = '';
            if (dataList.length === 0) { grid.innerHTML = '<div style="color:#888;text-align:center; grid-column: 1/-1;">Bulunamadı.</div>'; return; }
            dataList.forEach(d => {
                let clickAction = isDeleteMode ? `selectCommunity('${d.id}')` : `openCommunity('${d.id}')`;
                let selectClass = selectedComms.has(d.id) ? 'selected' : '';
                
                grid.innerHTML += `
                <div class="comm-card ${selectClass}" id="card-${d.id}" onclick="${clickAction}">
                    <img src="${d.image || 'https://via.placeholder.com/150'}" class="comm-img">
                    <div class="comm-content">
                        <div class="comm-title" style="font-weight:bold; color:#fff; font-size:14px; margin-bottom:5px;">${d.name}</div>
                        <div class="comm-desc" style="font-size:11px; color:#888;">${d.description ? d.description.substring(0,50) + '...' : ''}</div>
                    </div>
                </div>`;
            });
        }

        // --- YENİ SİLME MODU VE SEÇİM ---
        let isDeleteMode = false;
        let selectedComms = new Set();

        window.toggleDeleteMode = () => {
            isDeleteMode = !isDeleteMode;
            selectedComms.clear();
            document.getElementById('superAdminBtn').style.display = isDeleteMode ? 'none' : 'flex';
            document.getElementById('deleteActions').style.display = isDeleteMode ? 'flex' : 'none';
            document.getElementById('deleteCount').innerText = '0 seçildi';
            renderCommunityGrid(allCommunitiesCache);
        }

        window.selectCommunity = (id) => {
            if(selectedComms.has(id)) selectedComms.delete(id);
            else selectedComms.add(id);
            document.getElementById('deleteCount').innerText = `${selectedComms.size} seçildi`;
            renderCommunityGrid(allCommunitiesCache);
        }

        window.deleteSelectedCommunities = async () => {
            if(selectedComms.size === 0) return alert("Hiçbir topluluk seçmediniz.");
            if(!confirm(`${selectedComms.size} adet topluluğu silmek istediğinize emin misiniz?`)) return;
            try {
                for (const commId of selectedComms) {
                    const qP = query(collection(db, "posts"), where("communityId", "==", commId));
                    const pS = await getDocs(qP);
                    pS.forEach(async (p) => await deleteDoc(p.ref)); 
                    const qM = query(collection(db, "communityMembers"), where("communityId", "==", commId));
                    const mS = await getDocs(qM);
                    mS.forEach(async (m) => await deleteDoc(m.ref)); 
                    await deleteDoc(doc(db, "communities", commId)); 
                }
                alert("Seçilen topluluklar silindi.");
                toggleDeleteMode();
            } catch (e) {
                console.error(e);
                alert("Bir hata oluştu.");
            }
        }

        // TOPLULUK FONKSİYONLARI
        window.openCommunity = async function(commId) {
            currentOpenedCommunityId = commId;
            document.getElementById('communities').style.display = 'none';
            document.getElementById('communityDetail').style.display = 'block';
            document.getElementById('commFeedContainer').innerHTML = '<div class="empty-msg">Yükleniyor...</div>';
            
            const docSnap = await getDoc(doc(db, "communities", commId));
            if (!docSnap.exists()) return alert("Topluluk bulunamadı!");
            
            const data = docSnap.data();
            currentOpenedCommunityAdminId = data.createdBy;
            document.getElementById('cdName').innerText = data.name;
            document.getElementById('cdDesc').innerText = data.description;
            document.getElementById('cdCover').src = data.image || 'https://via.placeholder.com/800x200';
            
            const isAdmin = (currentUserUid === data.createdBy);
            const postBox = document.getElementById('commAdminPostBox');
            const adminBadge = document.getElementById('cdAdminBadge');
            const joinBtn = document.getElementById('cdJoinBtn');
            const adminOptions = document.getElementById('commAdminOptions');
            
            if (isAdmin) {
                postBox.style.display = 'block'; 
                adminBadge.style.display = 'inline-block';
                joinBtn.style.display = 'none'; 
                adminOptions.style.display = 'block'; 
            } else {
                postBox.style.display = 'none'; 
                adminBadge.style.display = 'none';
                joinBtn.style.display = 'block'; 
                adminOptions.style.display = 'none'; 
                checkMembership(commId); 
            }
            loadCommunityPosts(commId);
        }

        window.closeCommunityDetail = function() {
            document.getElementById('communityDetail').style.display = 'none';
            document.getElementById('communities').style.display = 'block';
            currentOpenedCommunityId = null;
        }

        async function checkMembership(commId) {
            const btn = document.getElementById('cdJoinBtn');
            const q = query(collection(db, "communityMembers"), where("communityId", "==", commId), where("userId", "==", currentUserUid));
            const snap = await getDocs(q);
            if (!snap.empty) {
                btn.innerText = "Ayrıl"; btn.style.background = "#ff4b4b"; btn.style.color = "#fff"; 
                btn.onclick = () => leaveCommunity(commId, snap.docs[0].id);
            } else {
                btn.innerText = "Katıl"; btn.style.background = "#24caac"; btn.style.color = "#000"; 
                btn.onclick = () => joinCommunity(commId);
            }
        }

        window.joinCommunity = async function(commId) {
            await addDoc(collection(db, "communityMembers"), { communityId: commId, userId: currentUserUid, joinedAt: new Date() });
            await updateDoc(doc(db, "communities", commId), { memberCount: increment(1) });
            alert("Topluluğa katıldın!");
            checkMembership(commId); 
        }

        window.leaveCommunity = async function(commId, membershipDocId) {
            if(!confirm("Ayrılmak istiyor musun?")) return;
            await deleteDoc(doc(db, "communityMembers", membershipDocId));
            await updateDoc(doc(db, "communities", commId), { memberCount: increment(-1) });
            checkMembership(commId);
        }

        window.toggleCommAdminMenu = function() { document.getElementById('commAdminMenu').classList.toggle('active'); }

        window.deleteCurrentCommunity = async function() {
            if(!confirm("Bu topluluğu ve içindeki TÜM paylaşımları silmek istediğine emin misin?")) return;
            const commId = currentOpenedCommunityId;
            const postsQ = query(collection(db, "posts"), where("communityId", "==", commId)); 
            const postsSnap = await getDocs(postsQ); 
            postsSnap.forEach(async (doc) => { await deleteDoc(doc.ref); });
            const membersQ = query(collection(db, "communityMembers"), where("communityId", "==", commId)); 
            const membersSnap = await getDocs(membersQ); 
            membersSnap.forEach(async (doc) => { await deleteDoc(doc.ref); });
            await deleteDoc(doc(db, "communities", commId));
            alert("Topluluk silindi.");
            closeCommunityDetail();
        }

        window.changeCommunityAdmin = async function() {
            const newAdminUsername = prompt("Yetkiyi devretmek istediğin kullanıcının kullanıcı adı:");
            if(!newAdminUsername) return;
            const userQ = query(collection(db, "users"), where("username", "==", newAdminUsername));
            const userSnap = await getDocs(userQ);
            if(userSnap.empty) return alert("Kullanıcı bulunamadı!");
            const newAdminUid = userSnap.docs[0].id;
            if(confirm(`Yönetici yetkisini devretmek istiyor musun?`)) {
                await updateDoc(doc(db, "communities", currentOpenedCommunityId), { createdBy: newAdminUid });
                alert("Yetki devredildi.");
                closeCommunityDetail();
            }
        }

        window.triggerCommunityImageUpdate = function() { 
            document.getElementById('updateCommImgInput').click(); 
            document.getElementById('commAdminMenu').classList.remove('active'); 
        }
        
        window.updateCommunityImage = function(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = async function(e) { 
                    const base64Img = e.target.result; 
                    document.getElementById('cdCover').src = base64Img; 
                    await updateDoc(doc(db, "communities", currentOpenedCommunityId), { image: base64Img }); 
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        window.editGlobalPost = async function(postId, oldText) {
            const newText = prompt("Gönderiyi düzenle:", oldText);
            if(newText !== null && newText !== oldText) { await updateDoc(doc(db, "posts", postId), { text: newText, isEdited: true }); }
        }

        function loadCommunityPosts(commId) {
            const feed = document.getElementById('commFeedContainer');
            feed.innerHTML = ''; 
            const q = query(collection(db, "posts"), where("communityId", "==", commId), orderBy("timestamp", "desc"));
            onSnapshot(q, async (snapshot) => {
                // Gizlenen gönderileri al
                let hiddenPostIds = new Set();
                const hiddenQ = query(collection(db, "hiddenPosts"), where("userId", "==", currentUserUid));
                const hiddenSnap = await getDocs(hiddenQ);
                hiddenSnap.forEach(doc => {
                    hiddenPostIds.add(doc.data().postId);
                });

                if (snapshot.empty && feed.children.length === 0) { feed.innerHTML = '<div class="empty-msg" style="margin-top:20px;">Henüz paylaşım yok.</div>'; return; }
                snapshot.docChanges().forEach((change) => {
                    const postId = change.doc.id;
                    // Gizli gönderileri gösterme
                    if (hiddenPostIds.has(postId)) {
                        const el = document.getElementById(postId);
                        if(el) el.remove();
                        return;
                    }
                    if (change.type === "added") renderSingleCommunityPost(postId, change.doc.data(), feed);
                    if (change.type === "modified") updateSingleCommunityPostUI(postId, change.doc.data());
                    if (change.type === "removed") { const el = document.getElementById(postId); if(el) el.remove(); }
                });
            });
        }

        function renderSingleCommunityPost(postId, post, container) {
            const emptyMsg = container.querySelector('.empty-msg'); if(emptyMsg) emptyMsg.remove();
            let imageHTML = "";
            if (post.mediaUrl) { 
                if (post.type === 'video') imageHTML = `<video src="${post.mediaUrl}" controls class="post-image" style="background:#000; width:100%; max-height:400px;"></video>`; 
                else imageHTML = `<img src="${post.mediaUrl}" class="post-image">`; 
            }
            
            let menuContent = (post.uid === currentUserUid) ? 
                `<div class="option-item" onclick="editGlobalPost('${postId}', '${post.text.replace(/'/g, "\\'")}')">Düzenle</div><div class="option-item danger" onclick="deleteGlobalPost('${postId}')">Sil</div>` : 
                `<div class="option-item" onclick="openReportModal('${postId}')">Bildir</div>`;
            
            const adminLabel = (post.uid === currentOpenedCommunityAdminId) ? '<span style="color:#24caac;font-size:10px; background:rgba(36,202,172,0.1); padding:2px 4px; border-radius:3px;">YÖNETİCİ</span>' : '';
            let dateStr = post.timestamp ? new Date(post.timestamp.seconds * 1000).toLocaleDateString("tr-TR") : "Az önce";
            const isLiked = post.likedBy && post.likedBy.includes(currentUserUid); const heartIcon = isLiked ? 'fa-solid' : 'fa-regular'; const likeClass = isLiked ? 'liked' : '';
            
            const html = `
            <div class="feed-post" id="${postId}" style="border: 1px solid #333;">
                <div class="post-header">
                    <div class="user-info-group" onclick="window.location.href='takip.html?kisi=${post.uid}'" style="cursor:pointer;">
                        <img src="${post.userImg}" style="width:35px;height:35px;border-radius:50%;">
                        <div>
                            <div style="display:flex; align-items:center; gap:5px;"><strong>${post.username}</strong> ${adminLabel}</div>
                            <div style="font-size:11px;color:#888;">${dateStr}</div>
                        </div>
                    </div>
                    <div class="post-options">
                        <button class="options-btn" onclick="toggleMenu('cmenu-${postId}')"><i class="fa-solid fa-ellipsis"></i></button>
                        <div id="cmenu-${postId}" class="options-menu">
                            <div class="option-item" onclick="toggleLike('${postId}')">${likeText}</div>
                            ${menuContent}
                        </div>
                    </div>
                </div>
                <div class="post-content" id="content-${postId}">${post.text}</div>
                ${imageHTML}
                <div class="post-actions">
                    <div id="like-btn-${postId}" class="action-btn ${likeClass}" onclick="toggleLike('${postId}')"><i class="${heartIcon} fa-heart"></i> <span>${post.likes || 0}</span></div>
                    <div class="action-btn" onclick="toggleCommentSection('${postId}')"><i class="fa-regular fa-comment"></i> Yorum <span id="comm-count-${postId}" style="font-size:10px;"></span></div>
                    <div class="action-btn" onclick="openShareModal('${postId}')"><i class="fa-solid fa-share-nodes"></i> Paylaş</div>
                </div>
                <div id="comments-${postId}" class="comment-section">
                    <div class="comment-list" id="list-${postId}"></div>
                    <div class="comment-input-wrapper">
                        <input type="text" id="input-${postId}" placeholder="Yorum...">
                        <button class="comment-send-btn" onclick="saveComment('${postId}')"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>`;
            container.insertAdjacentHTML('afterbegin', html); 
            loadComments(postId);
        }

        function updateSingleCommunityPostUI(postId, post) {
            const likeBtn = document.getElementById(`like-btn-${postId}`);
            if (likeBtn) {
                const isLiked = post.likedBy && post.likedBy.includes(currentUserUid); const heartIcon = isLiked ? 'fa-solid' : 'fa-regular';
                if (isLiked) likeBtn.classList.add('liked'); else likeBtn.classList.remove('liked');
                likeBtn.innerHTML = `<i class="${heartIcon} fa-heart"></i> <span>${post.likes || 0}</span>`;
            }
        }

        window.shareCommunityPost = async function() {
            const textInput = document.getElementById('commPostInput'); 
            const previewContainer = document.getElementById('commImagePreviewContainer'); 
            const previewImage = document.getElementById('commImagePreview');
            const text = textInput.value; 
            const hasMedia = previewContainer.style.display === 'block'; 
            const mediaUrl = hasMedia ? previewImage.src : null;
            
            if (!text && !hasMedia) return alert("İçerik girmelisiniz.");
            try { 
                await addDoc(collection(db, "posts"), { 
                    uid: myUser.uid, 
                    username: myUser.username, 
                    userImg: myUser.photoURL || defaultUserImg, 
                    text: text, 
                    mediaUrl: mediaUrl, 
                    type: hasMedia ? currentCommMediaType : 'text', 
                    timestamp: serverTimestamp(), 
                    communityId: currentOpenedCommunityId, 
                    likes: 0, 
                    likedBy: [] 
                }); 
                textInput.value = ""; 
                removeCommImage(); 
            } catch(e) { 
                console.error(e); 
            }
        }

        window.previewCommMedia = function(input) { 
            if (input.files && input.files[0]) { 
                const file = input.files[0]; 
                const reader = new FileReader(); 
                if (file.type.startsWith('video/')) currentCommMediaType = 'video'; 
                else currentCommMediaType = 'image'; 
                reader.onload = (e) => { 
                    document.getElementById('commImagePreview').src = e.target.result; 
                    document.getElementById('commImagePreviewContainer').style.display = 'block'; 
                }; 
                reader.readAsDataURL(file); 
            } 
        }
        
        window.removeCommImage = function() { 
            document.getElementById('commFileInput').value = ""; 
            document.getElementById('commImagePreview').src = ""; 
            document.getElementById('commImagePreviewContainer').style.display = 'none'; 
            currentCommMediaType = 'image'; 
        }

        // GÜNCELLENMİŞ KEŞFET YÜKLEME (Takip Edilenler Dahil)
        async function loadExploreMixed() { 
            // 0. Gizlenen gönderileri al
            let hiddenPostIds = new Set();
            const hiddenQ = query(collection(db, "hiddenPosts"), where("userId", "==", currentUserUid));
            const hiddenSnap = await getDocs(hiddenQ);
            hiddenSnap.forEach(doc => {
                hiddenPostIds.add(doc.data().postId);
            });

            // 1. Önce Takip Ettiklerimi Bul (Status: 'accepted')
            let friendUids = [];
            if (currentUserUid) {
                const qRel = query(
                    collection(db, "relationships"), 
                    where("followerUid", "==", currentUserUid),
                    where("status", "==", "accepted")
                );
                const relSnap = await getDocs(qRel);
                relSnap.forEach(doc => friendUids.push(doc.data().followingUid));
            }

            // 2. Sorguları Hazırla
            const promises = [];
            
            // A) Global Postlar (Son 20)
            promises.push(getDocs(query(collection(db, "posts"), orderBy("timestamp", "desc"), limit(20))));
            
            // B) Haberler (Son 20)
            promises.push(getDocs(query(collection(db, "news"), orderBy("timestamp", "desc"), limit(20))));

            // C) Arkadaş Postları (Eğer arkadaşın varsa)
            if (friendUids.length > 0) {
                // Firestore 'IN' sorgusu en fazla 10 eleman alır, bu yüzden son 10 arkadaşı alıyoruz
                // (Daha fazlası için chunking gerekir ama bu proje için yeterli)
                const limitedFriends = friendUids.slice(0, 10); 
                promises.push(getDocs(query(collection(db, "posts"), where("uid", "in", limitedFriends), orderBy("timestamp", "desc"), limit(10))));
            }

            // 3. Tüm Verileri Çek
            const results = await Promise.all(promises);
            const globalSnap = results[0];
            const newsSnap = results[1];
            const friendsSnap = (friendUids.length > 0) ? results[2] : null;

            // 4. Verileri İşle ve Birleştir
            explorePostData = [];
            exploreNewsData = [];
            const addedIds = new Set(); // Aynı postu iki kere eklememek için (hem globalde hem arkadaşta olabilir)

            // Arkadaş Postlarını Ekle (Öncelikli)
            if (friendsSnap) {
                friendsSnap.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    data.typeSrc = 'post';
                    // Gizli gönderiyi gösterme ve sadece medyası olanları keşfete ekle
                    if ((data.image || data.mediaUrl) && !addedIds.has(data.id) && !hiddenPostIds.has(data.id)) { 
                        explorePostData.push(data);
                        addedIds.add(data.id);
                    }
                });
            }

            // Global Postları Ekle
            globalSnap.forEach(doc => {
                const data = doc.data();
                data.id = doc.id;
                data.typeSrc = 'post';
                // Gizli gönderiyi gösterme
                if ((data.image || data.mediaUrl) && !addedIds.has(data.id) && !hiddenPostIds.has(data.id)) { 
                    explorePostData.push(data);
                    addedIds.add(data.id);
                }
            });

            // Haberleri Ekle
            newsSnap.forEach(doc => {
                const data = doc.data();
                data.id = doc.id;
                data.typeSrc = 'news';
                window.newsDataCache[data.id] = data;
                if (data.image) exploreNewsData.push(data);
            });

            // 5. Grid'i Oluştur
            renderExploreGrid(); 
        }

        function renderExploreGrid() { 
            const grid = document.querySelector('.explore-grid'); 
            // Postlar ve Haberleri birleştir
            let combined = [...explorePostData, ...exploreNewsData]; 
            
            // Tarihe göre yeniden eskiye sırala
            combined.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)); 
            
            grid.innerHTML = ''; 
            
            if (combined.length === 0) { 
                grid.innerHTML = '<div class="empty-msg">Henüz içerik yok.</div>'; 
                return; 
            } 
            
            combined.forEach(item => { 
                let content = ''; 
                let clickAction = ''; 
                let badge = ''; 
                
                // --- HABER İSE ---
                if (item.typeSrc === 'news') { 
                    if (item.type === 'video') { 
                        content = `<video src="${item.image}" muted loop onmouseover="this.play()" onmouseout="this.pause()"></video>`; 
                    } else { 
                        content = `<img src="${item.image}">`; 
                    } 
                    // Yeşil Etiket
                    badge = `<div class="news-badge">HABER</div>`; 
                    clickAction = `viewNews('${item.id}')`; 
                
                // --- NORMAL GÖNDERİ VEYA TOPLULUK GÖNDERİSİ İSE ---
                } else { 
                    if (item.type === 'video') { 
                        content = `<video src="${item.mediaUrl}" muted loop onmouseover="this.play()" onmouseout="this.pause()"></video>`; 
                    } else { 
                        content = `<img src="${item.image || item.mediaUrl}">`; 
                    } 

                    // Normal gönderi tıklandığında ana sayfada o gönderiye gitmeli
                    clickAction = `goToPost('${item.id}')`;

                    // EĞER TOPLULUK ID'Sİ VARSA ETİKET EKLE
                    if (item.communityId) {
                        // Turuncu Etiket
                        badge = `<div class="news-badge" style="background: #ff9800; color: #000;">TOPLULUK</div>`;
                    }
                } 
                
                const div = document.createElement('div'); 
                div.className = 'explore-item'; 
                if(clickAction) div.setAttribute('onclick', clickAction); 
                div.innerHTML = content + badge; 
                grid.appendChild(div); 
            }); 
        }

        window.viewNews = function(id) { 
            const data = window.newsDataCache[id]; 
            if(!data) return; 
            const mediaContainer = document.getElementById('detailNewsMediaContainer'); 
            if (data.type === 'video') { 
                mediaContainer.innerHTML = `<video src="${data.image}" controls style="width:100%; border-radius:10px; margin-bottom:15px; max-height:300px; background:black;"></video>`; 
            } else { 
                mediaContainer.innerHTML = `<img src="${data.image || 'https://via.placeholder.com/300x150'}" style="width:100%; border-radius:10px; margin-bottom:15px; max-height:300px; object-fit:cover;">`; 
            } 
            document.getElementById('detailNewsTitle').innerText = data.title; 
            document.getElementById('detailNewsAuthor').innerText = data.username || 'Anonim'; 
            document.getElementById('detailNewsDate').innerText = new Date(data.timestamp?.seconds * 1000).toLocaleDateString("tr-TR"); 
            document.getElementById('detailNewsContent').innerText = data.content; 
            document.getElementById('newsDetailModal').style.display = 'flex'; 
        }

        window.closeNewsDetailModal = function() { document.getElementById('newsDetailModal').style.display = 'none'; }
        window.openNewsModal = () => document.getElementById('newsModal').style.display='flex';
        window.closeNewsModal = () => document.getElementById('newsModal').style.display='none';
        
        window.shareNews = async function() { 
            const title = document.getElementById('newsTitle').value; 
            const content = document.getElementById('newsContent').value; 
            const file = document.getElementById('newsFile').files[0]; 
            if(!title || !content) return alert("Başlık ve içerik giriniz."); 
            let mediaType = 'image'; 
            let imgBase64 = null; 
            if(file) { 
                if (file.type.startsWith('video/')) mediaType = 'video'; 
                const reader = new FileReader(); 
                reader.readAsDataURL(file); 
                reader.onload = async function() { 
                    imgBase64 = reader.result; 
                    saveNewsToDB(title, content, imgBase64, mediaType); 
                } 
            } else { 
                saveNewsToDB(title, content, null, 'image'); 
            } 
        }
        
        async function saveNewsToDB(title, content, img, type) { 
            await addDoc(collection(db, "news"), { 
                title: title, content: content, image: img, type: type, uid: myUser.uid, username: myUser.username, timestamp: new Date() 
            }); 
            closeNewsModal(); 
            document.getElementById('newsTitle').value = ""; 
            document.getElementById('newsContent').value = ""; 
            document.getElementById('newsFile').value = ""; 
        }
        
        window.showSection = function(sectionId) { 
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active')); 
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active')); 
            document.getElementById(sectionId).classList.add('active'); 
            
            const navIcons = document.querySelectorAll('.nav-item');
            if(sectionId === 'home') navIcons[0].classList.add('active');
            else if(sectionId === 'explore') navIcons[2].classList.add('active');
            else if(sectionId === 'chat') navIcons[3].classList.add('active');
            else if(sectionId === 'notes') navIcons[4].classList.add('active');
            else if(sectionId === 'communities') navIcons[5].classList.add('active');
            
            const f = document.getElementById('followersBox'); 
            const c = document.getElementById('contactsBox'); 
            const cs = document.getElementById('commSearchBox');
            
            if(f) f.style.display = 'none'; 
            if(c) c.style.display = 'none'; 
            if(cs) cs.style.display = 'none';
            
            if(sectionId === 'home' && f) f.style.display = 'block';
            else if(sectionId === 'explore') loadExploreMixed(); 
            else if(sectionId === 'chat' && c) c.style.display = 'block';
            else if(sectionId === 'notes') renderFaculties(); 
            else if(sectionId === 'communities') { loadCommunities(); if(cs) cs.style.display = 'block'; }
        }

        function subscribeToRequests(myUid) { 
            const q = query(collection(db, "friendRequests"), where("toUid", "==", myUid)); 
            onSnapshot(q, (snapshot) => { 
                document.getElementById('navRequestCount').innerText = `İstekler (${snapshot.size})`; 
            }); 
        }
        
        async function loadSidebarLists(currentUid) { 
            const followersListDiv = document.getElementById('followersList'); 
            const contactsListDiv = document.getElementById('contactsList'); 
            const mobileContactsDiv = document.getElementById('mobileContactsInner'); 
            const shareListDiv = document.getElementById('shareModalList'); 
            const countSpan = document.getElementById('sidebarFollowerCount'); 
            const chatPageListDiv = document.getElementById('chatPageContactList');
            
            const q = query(collection(db, "relationships"), where("followingUid", "==", currentUid)); 
            const snapshot = await getDocs(q); 
            
            countSpan.innerText = `(${snapshot.size})`; 
            followersListDiv.innerHTML = ''; 
            contactsListDiv.innerHTML = ''; 
            shareListDiv.innerHTML = ''; 
            if(chatPageListDiv) chatPageListDiv.innerHTML = '';
            if(mobileContactsDiv) mobileContactsDiv.innerHTML = '';

            if (snapshot.empty) { 
                const emptyHtml = '<div style="color:#888;padding:10px;text-align:center;">Kimse yok.</div>';
                followersListDiv.innerHTML = emptyHtml; 
                contactsListDiv.innerHTML = emptyHtml; 
                if(mobileContactsDiv) mobileContactsDiv.innerHTML = emptyHtml;
                if(chatPageListDiv) chatPageListDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">Henüz mesajlaşacak kimse yok.</div>';
                return; 
            } 
            
            snapshot.forEach(async (docSnap) => { 
                const rel = docSnap.data(); 
                const userDoc = await getDoc(doc(db, "users", rel.followerUid)); 
                if(userDoc.exists()) { 
                    const uData = userDoc.data(); 
                    const uImg = uData.photoURL || defaultUserImg;
                    const onlineStatus = uData.isOnline ? 'Çevrimiçi' : 'Çevrimiçi değil';
                    
                    // Sidebar Takipçi Listesi
                    followersListDiv.insertAdjacentHTML('beforeend', `<div class="friend-row" onclick="goToProfile('${rel.followerUid}')" style="cursor:pointer;"><div class="friend-info"><img src="${uImg}"><span>${uData.username}</span></div><button class="remove-follow-btn" onclick="removeFollower('${docSnap.id}')" style="background:none; border:none; color:#ff4b4b; cursor:pointer;">Çıkar</button></div>`); 
                    
                    // Sidebar Hızlı Mesaj
                    contactsListDiv.insertAdjacentHTML('beforeend', `<div class="friend-row" onclick="loadChat('${uData.username}', '${uImg}', '${rel.followerUid}')" style="cursor:pointer;"><div class="friend-info"><div style="position:relative;"><img src="${uImg}"><div style="position:absolute;bottom:0;right:0;width:10px;height:10px;background:#24caac;border-radius:50%;"></div></div><div style="font-size:14px;">${uData.username}</div></div><i class="fa-regular fa-paper-plane" style="color:#666;"></i></div>`); 
                    
                    // Mobil Chat Listesi
                    if(mobileContactsDiv) {
                        mobileContactsDiv.insertAdjacentHTML('beforeend', `<div class="friend-row" onclick="loadChat('${uData.username}', '${uImg}', '${rel.followerUid}')" style="cursor:pointer; padding:10px; background:#222; margin-bottom:5px; border-radius:8px;"><div class="friend-info"><img src="${uImg}"><span>${uData.username}</span></div><i class="fa-solid fa-comment-dots" style="color:#24caac;"></i></div>`);
                    }

                    // Chat Sayfası Ana Listesi
                    if(chatPageListDiv) {
                        chatPageListDiv.insertAdjacentHTML('beforeend', `
                            <div class="friend-row" onclick="loadChat('${uData.username}', '${uImg}', '${rel.followerUid}')" style="cursor:pointer; padding:15px; background:#222; margin-bottom:10px; border-radius:10px; border:1px solid #333;">
                                <div class="friend-info">
                                    <img src="${uImg}" style="width:45px; height:45px;">
                                    <div>
                                        <div style="font-size:15px; font-weight:bold; color:white;">${uData.username} <span style="font-size:12px; color:#aaa;">${onlineStatus}</span></div>
                                    </div>
                                </div>
                                <i class="fa-solid fa-chevron-right" style="color:#24caac;"></i>
                            </div>
                        `);
                    }

                    // --- DÜZELTİLEN KISIM BURASI (PAYLAŞIM LİSTESİ) ---
                    // onclick içinde ARTIK RESİM YOK. Sadece ('İsim', 'ID') var.
                    shareListDiv.insertAdjacentHTML('beforeend', `
                        <div class="share-contact" style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #333;">
                            <div class="share-info" style="display:flex; align-items:center; gap:10px;">
                                <img src="${uImg}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;">
                                <span>${uData.username}</span>
                            </div>
                            <button class="share-send-btn" onclick="shareWithContact('${uData.username}', '${rel.followerUid}')" 
                                    style="background:#24caac; border:none; color:black; padding:5px 15px; border-radius:15px; font-weight:bold; cursor:pointer;">
                                Gönder
                            </button>
                        </div>
                    `); 
                } 
            }); 
        }

        function getChatRoomId(uid1, uid2) { return [uid1, uid2].sort().join("_"); }
        
        window.loadChat = function(name, imgUrl, targetUid) { 
            // 1. Ekranları Değiştir
            document.getElementById('chatContactListScreen').style.display = 'none';
            document.getElementById('activeChatScreen').style.display = 'flex';

            // 2. Başlık Bilgilerini Güncelle
            const nameEl = document.getElementById('chatHeaderName');
            const imgEl = document.getElementById('chatHeaderImg');
            
            nameEl.innerText = name; 
            imgEl.src = imgUrl; 

            // --- KULLANICIYU ÇEVRİMİÇİ DURUMUNU BAŞLIĞA EKLE ---
            (async () => {
                const userDoc = await getDoc(doc(db, "users", targetUid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const onlineStatus = userData.isOnline ? ' 🟢 Çevrimiçi' : ' ⚫ Çevrimiçi değil';
                    nameEl.innerText = name + onlineStatus;
                }
            })();

            // --- YENİ: BAŞLIĞA TIKLAYINCA PROFİLE GİT ---
            const goToProfile = () => {
                window.location.href = 'takip.html?kisi=' + targetUid;
            };
            
            // İsme ve Resme tıklama özelliği ver
            nameEl.onclick = goToProfile;
            nameEl.style.cursor = 'pointer'; // Tıklanabilir olduğunu göster (el işareti)
            
            imgEl.onclick = goToProfile;
            imgEl.style.cursor = 'pointer';
            // ---------------------------------------------
            
            // 3. Değişkenleri Ayarla
            currentChatPartnerUid = targetUid; 
            cancelReply(); 
            
            // 4. Eski dinleyiciyi durdur
            if (activeChatUnsubscribe) {
                activeChatUnsubscribe();
                activeChatUnsubscribe = null;
            }

            // 5. Mesaj Kutusunu TEMİZLE
            const chatBox = document.getElementById('chatBox'); 
            chatBox.innerHTML = '<div style="text-align:center; color:#555; margin-top:20px;"><i class="fa-solid fa-spinner fa-spin"></i> Mesajlar yükleniyor...</div>';

            // 6. Yeni Mesajları Getir
            const roomId = getChatRoomId(currentUserUid, targetUid); 
            const q = query(collection(db, "chats", roomId, "messages"), orderBy("timestamp", "asc")); 
            
            activeChatUnsubscribe = onSnapshot(q, (snapshot) => { 
                chatBox.innerHTML = ''; 
                
                if(snapshot.empty) { 
                    chatBox.innerHTML = '<div style="text-align:center;color:#555;margin-top:20px;">Burada henüz mesaj yok.<br>İlk mesajı sen at! 👋</div>'; 
                } 
                
                snapshot.forEach(doc => { 
                    const msg = doc.data(); 
                    const msgId = doc.id; 
                    const type = msg.senderId === currentUserUid ? "outgoing" : "incoming"; 
                    
                    let replyHtml = ""; 
                    if(msg.replyTo) replyHtml = `<div style="background:rgba(0,0,0,0.2); padding:3px 8px; border-left:2px solid #fff; margin-bottom:4px; border-radius:3px; font-size:11px;">↪ ${msg.replyTo.text.substring(0,20)}...</div>`; 
                    
                    let likeHtml = ""; 
                    if (msg.likes > 0) likeHtml = `<div class="msg-like-count">❤️ ${msg.likes}</div>`; 
                    
                    const likedByMe = msg.likedBy && msg.likedBy.includes(currentUserUid); 
                    const likeText = likedByMe ? "Vazgeç" : "Beğen"; 
                    
                    let messageContentHTML = "";
                    if (msg.isSharedPost && msg.postData) {
                        let mediaDisplay = "";
                        if (msg.postData.media) { 
                            if (msg.postData.type === 'video') mediaDisplay = `<video src="${msg.postData.media}" class="sp-media" muted></video>`; 
                            else mediaDisplay = `<img src="${msg.postData.media}" class="sp-media">`; 
                        }
                        messageContentHTML = `<div style="font-size:11px; margin-bottom:5px;">Gönderi ⤵</div><div class="shared-post-preview" onclick="goToPost('${msg.postData.id}')"><div class="sp-header"><i class="fa-solid fa-share"></i> ${msg.postData.owner}</div>${msg.postData.text ? `<div class="sp-text">${msg.postData.text}</div>` : ''}${mediaDisplay}</div>`;
                    } else { 
                        messageContentHTML = `<div class="msg-text">${msg.text} ${msg.isEdited ? '<span style="font-size:9px;color:#888;">(düz.)</span>' : ''}</div>`; 
                    }
                    
                    let menuContent = `
                        <div id="msg-menu-${msgId}" class="msg-menu" style="width:100px;">
                            ${!msg.isSharedPost ? `<div onclick="replyToMsg('${msgId}', '${msg.text.replace(/'/g, "\\'")}', '${name.replace(/'/g, "\\'")}')">Yanıtla</div>` : ''}
                            ${!msg.isSharedPost ? `<div onclick="copyMsg('${msg.text.replace(/'/g, "\\'")}')">Kopyala</div>` : ''}
                            <div onclick="toggleMsgLike('${roomId}', '${msgId}')">${likeText}</div>
                            ${msg.senderId === currentUserUid && !msg.isSharedPost ? `<div onclick="editMsg('${roomId}', '${msgId}', '${msg.text.replace(/'/g, "\\'")}')">Düzenle</div>` : ''}
                            <div onclick="deleteMsg('${roomId}', '${msgId}')" style="color:#ff4b4b;">Sil</div>
                        </div>`; 
                    
                    const div = document.createElement('div'); 
                    div.className = `msg ${type}`; 
                    div.setAttribute('ondblclick', `toggleMsgLike('${roomId}', '${msgId}')`); 
                    div.innerHTML = `${replyHtml}${messageContentHTML}<button class="msg-opt-btn" onclick="toggleMsgMenu('${msgId}')">•••</button>${menuContent}${likeHtml}`; 
                    chatBox.appendChild(div); 
                }); 
                chatBox.scrollTop = chatBox.scrollHeight; 
            }); 
        }

        window.goToPost = function(postId) { 
            showSection('home'); 
            setTimeout(() => { 
                const postEl = document.getElementById(postId); 
                if(postEl) { 
                    postEl.scrollIntoView({behavior: "smooth", block: "center"}); 
                    postEl.style.border = "2px solid #24caac"; 
                    setTimeout(() => postEl.style.border = "1px solid #333", 2000); 
                } else { 
                    alert("Bu gönderi şu anki akışta görünmüyor."); 
                } 
            }, 500); 
        }

        window.sendChatMessage = async function() { 
            const input = document.getElementById('chatMsgInput'); 
            const text = input.value.trim(); 
            if (!text || !currentChatPartnerUid) return; 
            const roomId = getChatRoomId(currentUserUid, currentChatPartnerUid); 
            try { 
                if (editingMsgId) { 
                    await updateDoc(doc(db, "chats", roomId, "messages", editingMsgId), { text: text, isEdited: true }); 
                    editingMsgId = null; 
                    input.value = ""; 
                    return; 
                } 
                await addDoc(collection(db, "chats", roomId, "messages"), { 
                    text: text, 
                    senderId: currentUserUid, 
                    timestamp: serverTimestamp(), 
                    likes: 0, 
                    likedBy: [], 
                    replyTo: replyingTo 
                }); 
                input.value = ""; 
                cancelReply(); 
            } catch (error) { 
                console.error("Mesaj hatası:", error); 
            } 
        }

        window.toggleMsgMenu = function(id) { 
            document.querySelectorAll('.msg-menu').forEach(m => { 
                if(m.id !== `msg-menu-${id}`) m.classList.remove('active'); 
            }); 
            const menu = document.getElementById(`msg-menu-${id}`); 
            if(menu) menu.classList.toggle('active'); 
        }
        
        window.toggleMsgLike = async function(roomId, msgId) { 
            const ref = doc(db, "chats", roomId, "messages", msgId); 
            const snap = await getDoc(ref); 
            if (snap.exists()) { 
                const m = snap.data(); 
                let likes = m.likes || 0; 
                let likedBy = m.likedBy || []; 
                if(likedBy.includes(currentUserUid)) { 
                    likes--; 
                    likedBy = likedBy.filter(id => id !== currentUserUid); 
                } else { 
                    likes++; 
                    likedBy.push(currentUserUid); 
                } 
                await updateDoc(ref, { likes: likes, likedBy: likedBy }); 
            } 
        }
        
        window.deleteMsg = async function(roomId, msgId) { 
            if(confirm("Sil?")) { await deleteDoc(doc(db, "chats", roomId, "messages", msgId)); } 
        }
        
        window.editMsg = function(roomId, msgId, text) { 
            const input = document.getElementById('chatMsgInput'); 
            input.value = text; 
            input.focus(); 
            editingMsgId = msgId; 
            document.querySelectorAll('.msg-menu').forEach(m => m.classList.remove('active')); 
        }
        
        window.replyToMsg = function(msgId, text, senderName) { 
            replyingTo = { id: msgId, text: text, sender: senderName }; 
            document.getElementById('replyPreviewBar').style.display = 'flex'; 
            document.getElementById('replyToText').innerText = `↪ ${senderName}: ${text.substring(0, 20)}...`; 
            document.querySelectorAll('.msg-menu').forEach(m => m.classList.remove('active')); 
            document.getElementById('chatMsgInput').focus(); 
        }
        
        window.cancelReply = function() { 
            replyingTo = null; 
            editingMsgId = null; 
            document.getElementById('replyPreviewBar').style.display = 'none'; 
            document.getElementById('chatMsgInput').value = ""; 
        }
        
        window.copyMsg = function(text) { 
            navigator.clipboard.writeText(text); 
            document.querySelectorAll('.msg-menu').forEach(m => m.classList.remove('active')); 
        }
        
        // ESKİ loadGlobalPosts YERİNE BUNU KULLANACAĞIZ
        async function loadTimeline() { 
            const feed = document.getElementById('feedContainer'); 
            
            // 1. Adım: Gizlenen gönderileri al
            let hiddenPostIds = new Set();
            const hiddenQ = query(collection(db, "hiddenPosts"), where("userId", "==", currentUserUid));
            const hiddenSnap = await getDocs(hiddenQ);
            hiddenSnap.forEach(doc => {
                hiddenPostIds.add(doc.data().postId);
            });

            // 2. Adım: Takip ettiğim kişilerin listesini al (Status: 'accepted' olanlar)
            const qRel = query(
                collection(db, "relationships"), 
                where("followerUid", "==", currentUserUid),
                where("status", "==", "accepted")
            );
            
            const relSnap = await getDocs(qRel);
            
            // İzin verilenler listesi (Başta sadece BEN varım)
            let allowedUids = [currentUserUid]; 
            
            // Takip ettiklerimi listeye ekle
            relSnap.forEach(doc => {
                allowedUids.push(doc.data().followingUid);
            });

            // 3. Adım: Gönderileri Çek ve Filtrele
            // Not: Firestore 'IN' sorgusu 30 ile sınırlı olduğu için client-side filtreleme yapıyoruz.
            const qPosts = query(collection(db, "posts"), orderBy("timestamp", "desc"), limit(50)); 
            
            onSnapshot(qPosts, (snapshot) => { 
                feed.innerHTML = ''; 
                
                if(snapshot.empty) { 
                    feed.innerHTML = '<div class="empty-msg">Henüz akışta gönderi yok.</div>'; 
                    return;
                } 

                let hasContent = false;

                snapshot.forEach(doc => { 
                    const post = doc.data();
                    
                    // --- SİHİRLİ KISIM: Gönderiyi gösterilip gösterilmeyeceğini kontrol et ---
                    // Eğer gönderi gizli listede varsa gösterme
                    if (hiddenPostIds.has(doc.id)) {
                        return;
                    }
                    
                    // Eğer gönderiyi atan kişi (post.uid), benim izinli listem (allowedUids) içindeyse göster
                    if (allowedUids.includes(post.uid)) {
                        createPostHTML(doc.id, post);
                        hasContent = true;
                    }
                });
                
                // Eğer takip ettiğim kimse gönderi atmamışsa
                if (!hasContent) {
                     feed.innerHTML = '<div class="empty-msg" style="text-align:center; padding:20px; color:#888;">Akışın boş.<br>Birilerini takip et veya bir şeyler paylaş!</div>';
                }
            }); 
        }

        function createPostHTML(postId, post) { 
            const feed = document.getElementById('feedContainer'); 
            const newPostDiv = document.createElement('div'); 
            newPostDiv.className = 'feed-post'; 
            newPostDiv.id = postId; 
            
            let imageHTML = ""; 
            if (post.type === 'video' && post.mediaUrl) 
                imageHTML = `<video src="${post.mediaUrl}" controls class="post-image" style="max-height:400px; background:#000; width:100%;"></video>`; 
            else if (post.mediaUrl) 
                imageHTML = `<img src="${post.mediaUrl}" class="post-image">`; 
            else if (post.image) 
                imageHTML = `<img src="${post.image}" class="post-image">`; 
            
            let dateStr = post.timestamp ? new Date(post.timestamp.seconds * 1000).toLocaleDateString("tr-TR") : ""; 
            let userImg = post.userImg || defaultUserImg;
            
            let menuOptions = ""; 
            if (auth.currentUser && post.uid === auth.currentUser.uid) { 
                menuOptions = `<div class="option-item" onclick="editGlobalPost('${postId}', '${post.text.replace(/'/g, "\\'")}')">Düzenle</div><div class="option-item danger" onclick="deleteGlobalPost('${postId}')">Sil</div>`; 
            } else { 
                menuOptions = `<div class="option-item" onclick="openReportModal('${postId}')">Bildir</div><div class="option-item" onclick="hideGlobalPost('${postId}')">Gizle</div>`; 
            }
            
            const liked = (post.likedBy && post.likedBy.includes(auth.currentUser.uid)); 
            const likeCount = post.likes || 0; 
            const likeText = liked ? "Vazgeç" : "Beğen"; 
            const heartIcon = liked ? 'fa-solid' : 'fa-regular'; 
            const likeClass = liked ? 'liked' : '';
            
            newPostDiv.innerHTML = `
            <div class="post-header">
                <div class="user-info-group" onclick="window.location.href='takip.html?kisi=${post.uid}'" style="cursor:pointer;">
                    <img src="${userImg}">
                    <div>
                        <strong>${post.username}</strong>
                        <div style="font-size:12px;color:#888;">${dateStr}</div>
                    </div>
                </div>
                
                <div class="post-options">
                    <button class="options-btn" onclick="toggleMenu('menu-${postId}')"><i class="fa-solid fa-ellipsis"></i></button>
                    <div id="menu-${postId}" class="options-menu">
                        <div class="option-item" onclick="toggleLike('${postId}')">${likeText}</div>
                        ${menuOptions}
                    </div>
                </div>
            </div>
            <div class="post-content">${post.text}</div>
            ${imageHTML}
            <div class="post-actions">
                <div class="action-btn ${likeClass}" onclick="toggleLike('${postId}')"><i class="${heartIcon} fa-heart"></i> <span>${likeCount}</span></div>
                <div class="action-btn" onclick="toggleCommentSection('${postId}')"><i class="fa-regular fa-comment"></i> <span id="count-${postId}">0</span></div>
                <div class="action-btn" onclick="openShareModal('${postId}')"><i class="fa-solid fa-share-nodes"></i></div>
            </div>
            <div id="comments-${postId}" class="comment-section">
                <div class="comment-list" id="list-${postId}"></div>
                <div class="comment-input-wrapper">
                    <input type="text" id="input-${postId}" placeholder="Yorum...">
                    <button class="comment-send-btn" onclick="saveComment('${postId}')">At</button>
                </div>
            </div>`; 
            
            feed.appendChild(newPostDiv); 
            loadComments(postId); 
        }

        window.previewMedia = function(input) { 
            if(input.files[0]){
                const r=new FileReader();
                r.onload=(e)=>{
                    currentMediaData=e.target.result;
                    document.getElementById('imagePreview').src=currentMediaData;
                    document.getElementById('imagePreviewContainer').style.display='block';
                };
                r.readAsDataURL(input.files[0]);
            }
        }
        
        window.removeImage = () => { 
            document.getElementById('fileInput').value = ""; 
            currentMediaData = null; 
            currentMediaType = null; 
            document.getElementById('imagePreviewContainer').style.display = 'none'; 
        }
        
        window.sharePost = async () => { 
            const t = document.getElementById('postInput').value; 
            if(!t && !currentMediaData) return alert("Boş gönderi paylaşamazsınız."); 
            await addDoc(collection(db, "posts"), { 
                uid: myUser.uid, 
                username: myUser.username, 
                userImg: myUser.photoURL || defaultUserImg,
                text: t, 
                mediaUrl: currentMediaData, 
                type: currentMediaType || 'text', 
                timestamp: new Date(), 
                likes: 0, 
                likedBy: [] 
            }); 
            document.getElementById('postInput').value = ""; 
            removeImage(); 
        }
        
        window.deleteGlobalPost = async (id) => { 
            if(confirm("Silmek istediğine emin misin?")) { 
                await deleteDoc(doc(db, "posts", id)); 
            } 
        }

        window.hideGlobalPost = async function(postId) {
            try {
                // Gizlenen gönderiyi kaydet
                await addDoc(collection(db, "hiddenPosts"), {
                    userId: currentUserUid,
                    postId: postId,
                    timestamp: serverTimestamp()
                });
                
                const post = document.getElementById(postId);
                if (post) {
                    post.style.display = 'none';
                    alert("Gönderi gizlendi.");
                }
            } catch (error) {
                console.error("Gizleme hatası:", error);
                alert("Gönderi gizlenemedi.");
            }
        }
        
        window.filterUsers = async () => { 
            const val = document.getElementById('globalSearchInput').value.toLowerCase(); 
            const res = document.getElementById('searchResults'); 
            res.innerHTML = ''; 
            if (val.length === 0) { 
                res.style.display = 'none'; 
                return; 
            } 
            const q = query(collection(db, "users"), where("searchKey", ">=", val), where("searchKey", "<=", val + "\uf8ff"), limit(10)); 
            const snap = await getDocs(q); 
            if (!snap.empty) { 
                res.style.display = 'block'; 
                const set = new Set(); 
                snap.forEach((doc) => { 
                    const d = doc.data(); 
                    if (set.has(d.username)) return; 
                    set.add(d.username); 
                    const item = document.createElement('div'); 
                    item.className = 'search-item'; 
                    item.innerHTML = `<img src="${d.photoURL || defaultUserImg}"><span>${d.username}</span>`; 
                    item.onclick = function() { window.location.href = 'takip.html?kisi=' + d.uid; }; 
                    res.appendChild(item); 
                }); 
            } else { 
                res.style.display = 'none'; 
            } 
        }
        
        window.toggleMenu = (id) => document.getElementById(id).classList.toggle('active');
        
        window.removeFollower = async (id) => { 
            if(confirm("Çıkar?")) { 
                await deleteDoc(doc(db, "relationships", id)); 
                loadSidebarLists(auth.currentUser.uid); 
            } 
        }
        
        window.toggleLike = async function(postId) { 
            const ref = doc(db, "posts", postId); 
            const snap = await getDoc(ref); 
            if (snap.exists()) { 
                const p = snap.data(); 
                const uid = auth.currentUser.uid; 
                let likes = p.likes || 0; 
                let likedBy = p.likedBy || []; 
                if (likedBy.includes(uid)) { 
                    likes--; 
                    likedBy = likedBy.filter(id => id !== uid); 
                } else { 
                    likes++; 
                    likedBy.push(uid); 
                } 
                await updateDoc(ref, { likes: likes, likedBy: likedBy }); 
                document.getElementById(`menu-${postId}`).classList.remove('active'); 
            } 
        }
        
        window.toggleCommentSection = (id) => { 
            const el=document.getElementById(`comments-${id}`); 
            el.style.display=el.style.display==='block'?'none':'block'; 
        }
        
        function loadComments(postId) { 
            const l = document.getElementById(`list-${postId}`); 
            const countSpan = document.getElementById(`comm-count-${postId}`) || document.getElementById(`count-${postId}`); 
            const q = query(collection(db, "comments"), where("postId", "==", postId), orderBy("timestamp", "asc")); 
            onSnapshot(q, (snap) => { 
                l.innerHTML = ''; 
                if(countSpan) countSpan.innerText = snap.size > 0 ? `${snap.size}` : '0'; 
                snap.forEach(doc => { 
                    const c = doc.data(); 
                    const cid = doc.id; 
                    let menu = (auth.currentUser && c.uid === auth.currentUser.uid) ? `<i class="fa-solid fa-trash" style="font-size:10px; cursor:pointer; color:#555;" onclick="deleteComment('${cid}')"></i>` : ''; 
                    l.innerHTML += `<div class="single-comment"><img src="${c.userImg || defaultUserImg}"><div class="comment-content"><div style="font-weight:bold;font-size:12px; color:#24caac;">${c.username}</div><div id="ctext-${cid}">${c.text}</div></div><div style="margin-left:auto;">${menu}</div></div>`; 
                }); 
            }); 
        }
        
        window.saveComment = async function(postId) { 
            const i = document.getElementById(`input-${postId}`); 
            if(!i.value.trim()) return; 
            await addDoc(collection(db, "comments"), { 
                postId: postId, 
                text: i.value, 
                uid: myUser.uid, 
                username: myUser.username, 
                userImg: myUser.photoURL || defaultUserImg, 
                timestamp: new Date() 
            }); 
            i.value = ""; 
        }
        
        window.deleteComment = async function(cid) { 
            if(confirm("Sil?")) await deleteDoc(doc(db, "comments", cid)); 
        }
        
        let currentPostIdToShare = null;
        window.openShareModal = (id) => { 
            currentPostIdToShare = id; 
            document.getElementById('shareModal').style.display='flex'; 
            loadShareList(); 
        }
        window.closeShareModal = () => document.getElementById('shareModal').style.display='none';
        
        // --- PAYLAŞILAN GÖNDERİYİ SOHBETE MESAJ OLARAK ATMA ---
        // --- DÜZELTİLMİŞ PAYLAŞIM FONKSİYONU ---
        // --- PAYLAŞILAN GÖNDERİYİ SOHBETE MESAJ OLARAK ATMA ---
        window.shareWithContact = async function(contactName, targetUid) {
            // Hangi gönderi? (Global değişkenden alıyoruz)
            if (!currentPostIdToShare) {
                alert("Hata: Paylaşılacak gönderi seçilmedi.");
                return;
            }

            try {
                // 1. Önce Gönderinin Verilerini Çekelim
                const postRef = doc(db, "posts", currentPostIdToShare);
                const postSnap = await getDoc(postRef);

                if (!postSnap.exists()) {
                    alert("Bu gönderi silinmiş, paylaşılamaz.");
                    return;
                }

                const pData = postSnap.data();

                // 2. Sohbet Odası ID'sini Oluştur
                const currentId = currentUserUid || myUid; 
                const roomId = [currentId, targetUid].sort().join("_");

                // 3. Mesajı Hazırla ve Gönder
                await addDoc(collection(db, "chats", roomId, "messages"), {
                    senderId: currentId,
                    recipientId: targetUid,
                    timestamp: serverTimestamp(),
                    isRead: false,
                    isSharedPost: true,
                    postData: {
                        id: currentPostIdToShare,
                        owner: pData.username,
                        userImg: pData.userImg || defaultUserImg,
                        text: pData.text || "",
                        media: pData.mediaUrl || pData.image || null,
                        type: pData.type || 'text'
                    }
                });

                // 4. Modalı Kapat ve Bilgi Ver
                closeShareModal();
                
                // Kullanıcıya sor: Sohbete gidelim mi?
                if (confirm(`${contactName} kişisine gönderildi! Sohbete gitmek ister misin?`)) {
                     const uDoc = await getDoc(doc(db, "users", targetUid));
                     const uPhoto = uDoc.exists() ? (uDoc.data().photoURL || defaultUserImg) : defaultUserImg;
                     loadChat(contactName, uPhoto, targetUid);
                }

            } catch (error) {
                console.error("Paylaşım hatası:", error);
                alert("Mesaj gönderilirken bir hata oluştu.");
            }
        }
        
        window.userLogout = () => signOut(auth).then(() => location.href = "login.html");
        window.toggleSettings = () => document.getElementById('settingsMenu').classList.toggle('active');
        window.openModal = () => document.getElementById('noteModal').style.display='flex';
        window.closeModal = () => document.getElementById('noteModal').style.display='none';
        window.openCommModal = () => document.getElementById('commModal').style.display='flex';
        window.closeCommModal = () => document.getElementById('commModal').style.display='none';
        window.openReportModal = (id) => { currentReportPostId = id; document.getElementById('reportModal').style.display='flex'; }
        window.closeReportModal = () => { document.getElementById('reportModal').style.display='none'; currentReportPostId = null; }
        
        // ŞİKAYET GÖNDERME FONKSİYONU (DÜZELTİLMİŞ)
        let currentReportPostId = null;
        // 3. Şikayeti Gönder (Güncellenmiş: Link Eklemeli)
        window.submitReport = async () => {
            const reason = document.getElementById('reportReason').value.trim();
            if(!reason) return alert("Lütfen bir sebep yazınız.");
            
            const btn = document.querySelector('#reportModal .modal-buttons button:last-child');
            btn.innerText = "Gönderiliyor...";
            btn.disabled = true;

            try {
                // A) Şikayet edilen gönderinin detaylarını çek
                const postRef = doc(db, "posts", currentReportPostId);
                const postSnap = await getDoc(postRef);
                
                let postOwner = "Bilinmiyor";
                let postContent = "İçerik Yok/Medya";

                if (postSnap.exists()) {
                    const p = postSnap.data();
                    postOwner = p.username;
                    postContent = p.text ? p.text.substring(0, 50) + "..." : "Sadece Görsel/Video";
                }

                // --- YENİ: DİREKT LİNK OLUŞTURMA ---
                // Mevcut sayfa adresini al (örn: https://siten.com/pylsmgemini.html)
                const baseUrl = window.location.href.split('?')[0]; 
                // Sonuna parametre ekle
                const postLink = `${baseUrl}?openPost=${currentReportPostId}`;

                // B) Veritabanına Rapor Olarak Kaydet
                await addDoc(collection(db, "reports"), {
                    postId: currentReportPostId,
                    reason: reason,
                    reportedBy: myUser.uid,
                    reporterName: myUser.username,
                    timestamp: serverTimestamp()
                });

                // C) SANA MAIL ATMA KISMI (EmailJS)
                const templateParams = {
                    reporter_name: myUser.username,
                    reason: reason,
                    post_id: currentReportPostId,
                    post_owner: postOwner,
                    post_content: postContent,
                    post_link: postLink // <--- YENİ EKLENEN LİNK
                };

                // ID'LERİNİ BURAYA YAZMAYI UNUTMA
                await emailjs.send('service_0z7sl3w', 'template_afv7n7t', templateParams);

                alert("Bildiriminiz yöneticiye iletildi.");
                closeReportModal();

            } catch (error) {
                console.error("Rapor hatası:", error);
                alert("Rapor kaydedildi ancak mail sunucusunda hata oluştu.");
                closeReportModal();
            } finally {
                btn.innerText = "Gönder";
                btn.disabled = false;
            }
        }

        window.createCommunity = async () => { 
            const n = document.getElementById('cName').value; 
            const d = document.getElementById('cDesc').value; 
            const f = document.getElementById('cFile').files[0]; 
            if(!n) return alert("İsim gerekli"); 
            let i = null; 
            if(f) { 
                const r = new FileReader(); 
                r.onload=async()=>{
                    i=r.result; 
                    saveComm(n,d,i);
                }; 
                r.readAsDataURL(f); 
            } else { 
                saveComm(n,d,null); 
            } 
        }
        
        async function saveComm(name, desc, img) { 
            const docRef = await addDoc(collection(db, "communities"), { 
                name, 
                description: desc, 
                image: img, 
                createdAt: new Date(), 
                createdBy: currentUserUid, 
                memberCount: 1, 
                searchKey: name.toLowerCase() 
            }); 
            await addDoc(collection(db, "communityMembers"), { 
                communityId: docRef.id, 
                userId: currentUserUid, 
                joinedAt: new Date() 
            }); 
            closeCommModal(); 
            window.location.href=`topluluk-sayfa.html?id=${docRef.id}`; 
        }
        
        function loadCommunities() { 
            const grid = document.getElementById('communityGrid'); 
            const q = query(collection(db, "communities"), orderBy("createdAt", "desc")); 
            onSnapshot(q, (snap) => { 
                allCommunitiesCache = []; 
                if(snap.empty) { 
                    grid.innerHTML='<div style="color:#888;text-align:center;">Henüz topluluk yok.</div>'; 
                    return;
                } 
                snap.forEach(doc => { 
                    let d = doc.data(); 
                    d.id = doc.id; 
                    allCommunitiesCache.push(d); 
                }); 
                renderCommunityGrid(allCommunitiesCache); 
            }); 
        }
        
        window.deleteSpecificSpamCommunities = async function() { 
            if(!confirm("aca, asdas ve dafas silinecek?")) return; 
            const n = ["aca", "asdas", "dafas"]; 
            try { 
                for (const name of n) { 
                    const q = query(collection(db, "communities"), where("name", "==", name)); 
                    const s = await getDocs(q); 
                    s.forEach(async (d) => { 
                        const qP = query(collection(db, "posts"), where("communityId", "==", d.id)); 
                        const pS = await getDocs(qP); 
                        pS.forEach(async (p) => await deleteDoc(p.ref)); 
                        await deleteDoc(d.ref); 
                    }); 
                } 
                alert("Temizlendi."); 
            } catch (e) { 
                console.error(e); 
            } 
        }
        
        window.onclick = (e) => { 
            if(!e.target.closest('.options-btn') && !e.target.closest('.comment-menu-btn') && !e.target.closest('.msg-opt-btn') && !e.target.closest('.comm-opt-btn')) { 
                document.querySelectorAll('.options-menu, .comment-options-menu, .msg-menu').forEach(m => m.classList.remove('active')); 
            }
            if(e.target.id === 'shareModal') closeShareModal();
            if(e.target.id === 'newsModal') closeNewsModal();
            if(e.target.id === 'noteModal') closeModal();
            if(e.target.id === 'commModal') closeCommModal();
            if(e.target.id === 'newsDetailModal') closeNewsDetailModal();
            if(e.target.id === 'reportModal') closeReportModal();
        }
        window.closeActiveChat = function() {
            // Sohbeti gizle, Listeyi göster
            document.getElementById('activeChatScreen').style.display = 'none';
            document.getElementById('chatContactListScreen').style.display = 'flex';
            
            // Aktif dinleyiciyi durdur (performans için)
            if (activeChatUnsubscribe) {
                activeChatUnsubscribe();
                activeChatUnsubscribe = null;
            }
            currentChatPartnerUid = null;
        }
        // --- SAYFA YÜKLENDİĞİNDE LİNKLERİ KONTROL ET ---
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            
            // 1. Şikayet Edilen Gönderiyi Açma Kontrolü
            const openPostId = params.get('openPost');
            if (openPostId) {
                // Sayfa ve veriler yüklenene kadar biraz bekleyelim (2 saniye)
                setTimeout(() => {
                    goToPost(openPostId);
                    // URL'yi temizle ki sayfa yenilenince tekrar gitmesin
                    window.history.replaceState({}, document.title, window.location.pathname);
                }, 2000);
            }

            // 2. Sohbet Açma Kontrolü (Zaten vardı, koruyoruz)
            const chatUserUid = params.get('chatUser');
            if (chatUserUid) {
                // (Mevcut sohbet açma kodun burada çalışır, çakışmaz)
            }
        });
        // --- TEMA DEĞİŞTİRME SİSTEMİ ---
        window.addEventListener('load', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
            }
            updateThemeIcon();
        });

        window.toggleTheme = function() {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const icon = document.getElementById('themeIcon');
            if (icon) {
                if (document.body.classList.contains('light-mode')) {
                    icon.className = 'fa-solid fa-sun'; 
                    icon.style.color = '#ff9800';
                } else {
                    icon.className = 'fa-solid fa-moon'; 
                    icon.style.color = '#ccc';
                }
            }
        }

        // --- SAYFAYI KAPATIRKEN ÇEVRIMIÇI DURUMUNU GÜNCELLE ---
        window.addEventListener('beforeunload', async () => {
            if (currentUserUid) {
                try {
                    await updateDoc(doc(db, "users", currentUserUid), { isOnline: false });
                } catch(e) {
                    console.log("Online durumu güncellenemedi:", e);
                }
            }
        });
        
    </script>
</body>
</html>