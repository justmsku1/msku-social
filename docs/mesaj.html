<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesajlar - Just MSKU</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="style.css">

    <style>
        /* --- CHAT SAYFASINA Ã–ZEL STÄ°LLER --- */
        body { background-color: #000; color: #fff; font-family: 'Montserrat', sans-serif; overflow: hidden; }

        /* HEADER */
        header { 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 15px 20px; background: #111; border-bottom: 1px solid #333;
            height: 60px;
        }
        .header-title { font-size: 18px; font-weight: bold; color: #24caac; display: flex; align-items: center; gap: 10px; }
        .back-btn { color: #fff; font-size: 20px; cursor: pointer; }

        /* ANA KAPLAYICI */
        .chat-container { display: flex; height: calc(100vh - 60px); position: relative; }

        /* KULLANICI LÄ°STESÄ° (SOL TARAF) */
        .user-list-area { 
            width: 100%; 
            background: #000; 
            overflow-y: auto; 
            border-right: 1px solid #333;
        }
        .user-item { 
            display: flex; align-items: center; gap: 15px; 
            padding: 15px; border-bottom: 1px solid #222; cursor: pointer; transition: 0.2s;
        }
        .user-item:hover { background: #111; }
        .user-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid #333; }
        .user-info h4 { font-size: 15px; margin-bottom: 3px; color: #eee; }
        .user-info p { font-size: 12px; color: #888; }

        /* SOHBET ALANI (SAÄž TARAF) */
        .chat-area { 
            width: 100%; 
            background: #0a0a0a; 
            display: none; 
            flex-direction: column;
            position: absolute; top: 0; left: 0; height: 100%; z-index: 10;
        }
        
        /* Sohbet MesajlarÄ± */
        .messages-box { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        .message { max-width: 75%; padding: 10px 15px; border-radius: 15px; font-size: 14px; line-height: 1.4; position: relative; word-wrap: break-word; }
        .message.sent { align-self: flex-end; background: #24caac; color: #000; border-bottom-right-radius: 2px; }
        .message.received { align-self: flex-start; background: #222; color: #fff; border-bottom-left-radius: 2px; }
        
        .msg-time { font-size: 10px; margin-top: 5px; opacity: 0.7; text-align: right; display: block; }

        /* Mesaj Yazma AlanÄ± */
        .input-area { 
            padding: 15px; background: #111; border-top: 1px solid #333; 
            display: flex; align-items: center; gap: 10px; 
        }
        .msg-input { 
            flex: 1; background: #222; border: none; padding: 12px; 
            border-radius: 25px; color: #fff; outline: none; 
        }
        .send-btn { 
            background: #24caac; border: none; width: 40px; height: 40px; 
            border-radius: 50%; color: #000; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; font-size: 16px;
        }

        .empty-state { text-align: center; color: #666; margin-top: 50px; font-size: 14px; }
        .error-message { color: #ff4444; text-align: center; padding: 20px; font-size: 13px; }

        /* MasaÃ¼stÃ¼ Uyumu */
        @media (min-width: 768px) {
            .user-list-area { width: 350px; }
            .chat-area { display: flex; position: static; width: calc(100% - 350px); border-left: 1px solid #333; }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-title">
            <i class="fa-solid fa-arrow-left back-btn" id="mainBackBtn" onclick="goHome()"></i>
            <span id="headerText">Mesajlar</span>
        </div>
        <div id="chatUserHeader" style="display:none; align-items:center; gap:10px;">
            <img id="chatHeaderImg" src="" style="width:30px; height:30px; border-radius:50%; display:none;">
            <span id="chatHeaderName"></span>
        </div>
    </header>

    <div class="chat-container">
        <div id="userListArea" class="user-list-area">
            <div id="usersContainer">
                <div class="empty-state">KullanÄ±cÄ±lar yÃ¼kleniyor...</div>
            </div>
        </div>

        <div id="chatArea" class="chat-area">
            <div class="messages-box" id="messagesBox">
                <div class="empty-state">Sohbet baÅŸlatmak iÃ§in bir kullanÄ±cÄ± seÃ§in.</div>
            </div>

            <div class="input-area" id="inputArea" style="display:none;">
                <input type="text" id="msgInput" class="msg-input" placeholder="Mesaj yazÄ±n...">
                <button class="send-btn" onclick="sendMessage()">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, getDocs, where, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDLRlyPJvO5tPtnuzNAtO6H0_t7mo_3qoU",
            authDomain: "justmsku.firebaseapp.com",
            projectId: "justmsku",
            storageBucket: "justmsku.firebasestorage.app",
            messagingSenderId: "424626283802",
            appId: "1:424626283802:web:83502f1c09cdcf9acd78a3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentChatUser = null; 
        let messagesUnsubscribe = null; 

        // --- GÄ°RÄ°Åž KONTROLÃœ ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadUsers();
            } else {
                window.location.href = "login.html";
            }
        });

        // --- KULLANICILARI LÄ°STELE ---
        async function loadUsers() {
            const container = document.getElementById('usersContainer');
            try {
                const q = query(collection(db, "users"));
                const snapshot = await getDocs(q);
                
                container.innerHTML = "";

                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty-state">KayÄ±tlÄ± baÅŸka kullanÄ±cÄ± yok.</div>';
                    return;
                }

                snapshot.forEach(doc => {
                    const u = doc.data();
                    if (u.uid === currentUser.uid) return;

                    const img = u.photoURL || "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png";
                    
                    const div = document.createElement('div');
                    div.className = 'user-item';
                    div.onclick = () => openChat(u);
                    div.innerHTML = `
                        <img src="${img}" class="user-avatar">
                        <div class="user-info">
                            <h4>${u.username}</h4>
                            <p>Mesaj gÃ¶ndermek iÃ§in dokun</p>
                        </div>
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error("KullanÄ±cÄ±lar yÃ¼klenemedi:", error);
            }
        }

        // --- SOHBETÄ° AÃ‡ ---
        window.openChat = function(targetUser) {
            currentChatUser = targetUser;

            // Mobilde gÃ¶rÃ¼nÃ¼m deÄŸiÅŸimi
            if (window.innerWidth < 768) {
                document.getElementById('userListArea').style.display = 'none';
                document.getElementById('chatArea').style.display = 'flex';
                const backBtn = document.getElementById('mainBackBtn');
                backBtn.onclick = closeChatMobile;
                backBtn.className = "fa-solid fa-chevron-left back-btn";
            }

            // Header gÃ¼ncelleme
            document.getElementById('headerText').style.display = 'none';
            const chatHeader = document.getElementById('chatUserHeader');
            chatHeader.style.display = 'flex';
            document.getElementById('chatHeaderName').innerText = targetUser.username;
            document.getElementById('chatHeaderImg').src = targetUser.photoURL || "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png";
            document.getElementById('chatHeaderImg').style.display = 'block';

            document.getElementById('inputArea').style.display = 'flex';
            
            // MesajlarÄ± getir
            loadMessages(targetUser.uid);
        }

        // --- MESAJLARI CANLI YÃœKLE (Ä°Ã‡ Ä°Ã‡E KLASÃ–R YAPISI: Subcollection) ---
        function loadMessages(targetUid) {
            const box = document.getElementById('messagesBox');
            box.innerHTML = '<div class="empty-state">YÃ¼kleniyor...</div>';

            // 1. Oda KimliÄŸi OluÅŸtur (uid1_uid2 formatÄ±nda)
            const ids = [currentUser.uid, targetUid].sort();
            const chatId = ids[0] + "_" + ids[1];

            if (messagesUnsubscribe) messagesUnsubscribe();

            // 2. DOÄžRU ADRES: chats -> [ODA_NO] -> messages
            const messagesRef = collection(db, "chats", chatId, "messages");
            const q = query(messagesRef, orderBy("timestamp", "asc"));

            messagesUnsubscribe = onSnapshot(q, (snapshot) => {
                box.innerHTML = ""; 
                
                if (snapshot.empty) {
                    box.innerHTML = '<div class="empty-state">HenÃ¼z mesaj yok. Merhaba de! ðŸ‘‹</div>';
                    return;
                }

                snapshot.forEach(docSnap => {
                    const msg = docSnap.data();
                    const isMe = msg.senderId === currentUser.uid;
                    
                    // Okundu olarak iÅŸaretle (eÄŸer mesaj benim deÄŸilse)
                    if (!isMe && !msg.isRead) {
                        markAsRead(chatId, docSnap.id);
                    }

                    const time = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "...";

                    const div = document.createElement('div');
                    div.className = `message ${isMe ? 'sent' : 'received'}`;
                    div.innerHTML = `
                        ${msg.text}
                        <span class="msg-time">${time}</span>
                    `;
                    box.appendChild(div);
                });

                // En alta kaydÄ±r
                box.scrollTop = box.scrollHeight;
            }, (error) => {
                console.error("Mesaj yÃ¼kleme hatasÄ±:", error);
                box.innerHTML = `<div class="error-message">Mesajlar yÃ¼klenemedi: ${error.message}</div>`;
            });
        }

        // --- MESAJ GÃ–NDER ---
        window.sendMessage = async function() {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            
            if (!text || !currentChatUser) return;

            input.value = ""; 

            const ids = [currentUser.uid, currentChatUser.uid].sort();
            const chatId = ids[0] + "_" + ids[1];

            try {
                // MesajÄ± direkt chats -> [ODA_NO] -> messages altÄ±na ekle
                const messagesRef = collection(db, "chats", chatId, "messages");
                
                await addDoc(messagesRef, {
                    senderId: currentUser.uid,
                    receiverId: currentChatUser.uid,
                    text: text,
                    isRead: false,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error("Mesaj hatasÄ±:", error);
                alert("Mesaj gÃ¶nderilemedi: " + error.message);
            }
        }

        // --- OKUNDU OLARAK Ä°ÅžARETLE ---
        async function markAsRead(chatId, docId) {
            try {
                const msgRef = doc(db, "chats", chatId, "messages", docId);
                await updateDoc(msgRef, { isRead: true });
            } catch (e) {
                console.log("Okundu gÃ¼ncelleme hatasÄ±", e);
            }
        }

        // --- MOBÄ°L MENÃœ ---
        window.closeChatMobile = function() {
            document.getElementById('userListArea').style.display = 'block';
            document.getElementById('chatArea').style.display = 'none';
            document.getElementById('chatUserHeader').style.display = 'none';
            document.getElementById('headerText').style.display = 'block';
            
            const backBtn = document.getElementById('mainBackBtn');
            backBtn.onclick = goHome;
            backBtn.className = "fa-solid fa-arrow-left back-btn";
            
            if (messagesUnsubscribe) messagesUnsubscribe();
            currentChatUser = null;
        }

        window.goHome = function() {
            window.location.href = "pylsmgemini.html"; 
        }

        // Enter tuÅŸu desteÄŸi
        document.getElementById('msgInput').addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        });

    </script>
</body>
</html>